(()=>{"use strict";var e=(()=>(function(e){e[e.HELMET_ID=0]="HELMET_ID",e[e.GAUNTLET_ID=1]="GAUNTLET_ID",e[e.CHEST_ID=2]="CHEST_ID",e[e.LEG_ID=3]="LEG_ID",e[e.STATS_MOBILITY_RESILIENCE=4]="STATS_MOBILITY_RESILIENCE",e[e.STATS_RECOVERY_DISCIPLINE=5]="STATS_RECOVERY_DISCIPLINE",e[e.STATS_INTELLECT_STRENGTH=6]="STATS_INTELLECT_STRENGTH",e[e.EXOTIC_ID_LOBYTE=7]="EXOTIC_ID_LOBYTE",e[e.EXOTIC_ID_HIBYTE=8]="EXOTIC_ID_HIBYTE",e[e.MASTERWORK_NUMBER=9]="MASTERWORK_NUMBER",e[e.ELEMENTAL_AFFINITIES=10]="ELEMENTAL_AFFINITIES",e[e.WIDTH=11]="WIDTH"}(e||(e={})),e))(),t=(()=>(function(e){e[e.PERMUTATION_ID_BYTE0=0]="PERMUTATION_ID_BYTE0",e[e.PERMUTATION_ID_BYTE1=1]="PERMUTATION_ID_BYTE1",e[e.PERMUTATION_ID_BYTE2=2]="PERMUTATION_ID_BYTE2",e[e.PERMUTATION_ID_BYTE3=3]="PERMUTATION_ID_BYTE3",e[e.USED_MOD1=4]="USED_MOD1",e[e.USED_MOD2=5]="USED_MOD2",e[e.USED_MOD3=6]="USED_MOD3",e[e.USED_MOD4=7]="USED_MOD4",e[e.USED_MOD5=8]="USED_MOD5",e[e.WIDTH=9]="WIDTH"}(t||(t={})),t))(),r=(()=>(function(e){e[e.PowerfulFriends=0]="PowerfulFriends",e[e.RadiantLight=1]="RadiantLight",e[e.ProtectiveLight=100]="ProtectiveLight",e[e.ExtraReserves=101]="ExtraReserves",e[e.PreciselyCharged=102]="PreciselyCharged",e[e.StacksOnStacks=103]="StacksOnStacks",e[e.PrecisionCharge=104]="PrecisionCharge",e[e.SurpriseAttack=105]="SurpriseAttack",e[e.EnergyConverter=106]="EnergyConverter",e[e.ChargeHarvester=107]="ChargeHarvester",e[e.WhisperOfDurance=1e3]="WhisperOfDurance",e[e.WhisperOfChains=1001]="WhisperOfChains",e[e.WhisperOfConduction=1002]="WhisperOfConduction",e[e.WhisperOfShards=1003]="WhisperOfShards",e[e.WhisperOfHedrons=1100]="WhisperOfHedrons",e[e.WhisperOfBonds=1101]="WhisperOfBonds",e[e.WhisperOfHunger=1102]="WhisperOfHunger",e[e.WhisperOfFractures=1103]="WhisperOfFractures"}(r||(r={})),r))(),i=(()=>(function(e){e[e.CombatStyleMod=0]="CombatStyleMod",e[e.Stasis=1]="Stasis"}(i||(i={})),i))(),s=(()=>(function(e){e[e.NONE=0]="NONE",e[e.MINOR_MOBILITY=1]="MINOR_MOBILITY",e[e.MAJOR_MOBILITY=2]="MAJOR_MOBILITY",e[e.MINOR_RESILIENCE=3]="MINOR_RESILIENCE",e[e.MAJOR_RESILIENCE=4]="MAJOR_RESILIENCE",e[e.MINOR_RECOVERY=5]="MINOR_RECOVERY",e[e.MAJOR_RECOVERY=6]="MAJOR_RECOVERY",e[e.MINOR_DISCIPLINE=7]="MINOR_DISCIPLINE",e[e.MAJOR_DISCIPLINE=8]="MAJOR_DISCIPLINE",e[e.MINOR_INTELLECT=9]="MINOR_INTELLECT",e[e.MAJOR_INTELLECT=10]="MAJOR_INTELLECT",e[e.MINOR_STRENGTH=11]="MINOR_STRENGTH",e[e.MAJOR_STRENGTH=12]="MAJOR_STRENGTH"}(s||(s={})),s))(),a=(()=>(function(e){e[e.Mobility=0]="Mobility",e[e.Resilience=1]="Resilience",e[e.Recovery=2]="Recovery",e[e.Discipline=3]="Discipline",e[e.Intellect=4]="Intellect",e[e.Strength=5]="Strength"}(a||(a={})),a))(),n=(()=>(function(e){e[e.ClassAbilityRegenerationStat=10]="ClassAbilityRegenerationStat"}(n||(n={})),n))();const o={[r.PowerfulFriends]:{id:r.PowerfulFriends,name:"Powerful Friends",type:i.CombatStyleMod,bonus:[{stat:a.Mobility,value:20}],requiredArmorAffinity:1},[r.RadiantLight]:{id:r.RadiantLight,name:"Radiant Light",type:i.CombatStyleMod,bonus:[{stat:a.Strength,value:20}],requiredArmorAffinity:1},[r.ProtectiveLight]:{id:r.ProtectiveLight,name:"Protective Light",type:i.CombatStyleMod,bonus:[{stat:a.Strength,value:-10}],requiredArmorAffinity:3},[r.ExtraReserves]:{id:r.ExtraReserves,name:"Extra Reserves",type:i.CombatStyleMod,bonus:[{stat:a.Intellect,value:-10}],requiredArmorAffinity:3},[r.PreciselyCharged]:{id:r.PreciselyCharged,name:"Precisely Charged",type:i.CombatStyleMod,bonus:[{stat:a.Discipline,value:-10}],requiredArmorAffinity:3},[r.StacksOnStacks]:{id:r.StacksOnStacks,name:"Stacks on Stacks",type:i.CombatStyleMod,bonus:[{stat:a.Recovery,value:-10}],requiredArmorAffinity:3},[r.PrecisionCharge]:{id:r.PrecisionCharge,name:"Precision Charge",type:i.CombatStyleMod,bonus:[{stat:a.Strength,value:-10}],requiredArmorAffinity:3},[r.SurpriseAttack]:{id:r.SurpriseAttack,name:"Surprise Attack",type:i.CombatStyleMod,bonus:[{stat:a.Intellect,value:-10}],requiredArmorAffinity:3},[r.EnergyConverter]:{id:r.EnergyConverter,name:"Energy Converter",type:i.CombatStyleMod,bonus:[{stat:a.Discipline,value:-10}],requiredArmorAffinity:3},[r.ChargeHarvester]:{id:r.ChargeHarvester,name:"Charge Harvester",type:i.CombatStyleMod,bonus:[{stat:n.ClassAbilityRegenerationStat,value:-10}],requiredArmorAffinity:3},[r.WhisperOfDurance]:{id:r.WhisperOfDurance,name:"Whisper Of Durance",type:i.Stasis,bonus:[{stat:a.Strength,value:10}],requiredArmorAffinity:0},[r.WhisperOfChains]:{id:r.WhisperOfChains,name:"Whisper Of Chains",type:i.Stasis,bonus:[{stat:a.Recovery,value:10}],requiredArmorAffinity:0},[r.WhisperOfShards]:{id:r.WhisperOfShards,name:"Whisper Of Shards",type:i.Stasis,bonus:[{stat:a.Resilience,value:10}],requiredArmorAffinity:0},[r.WhisperOfConduction]:{id:r.WhisperOfConduction,name:"Whisper Of Conduction",type:i.Stasis,bonus:[{stat:a.Resilience,value:10},{stat:a.Intellect,value:10}],requiredArmorAffinity:0},[r.WhisperOfBonds]:{id:r.WhisperOfBonds,name:"Whisper of Bonds",type:i.Stasis,bonus:[{stat:a.Discipline,value:-10},{stat:a.Intellect,value:-10}],requiredArmorAffinity:0},[r.WhisperOfHedrons]:{id:r.WhisperOfHedrons,name:"Whisper of Hedrons",type:i.Stasis,bonus:[{stat:a.Strength,value:-10}],requiredArmorAffinity:0},[r.WhisperOfFractures]:{id:r.WhisperOfFractures,name:"Whisper of Fractures",type:i.Stasis,bonus:[{stat:a.Discipline,value:-10}],requiredArmorAffinity:0},[r.WhisperOfHunger]:{id:r.WhisperOfHunger,name:"Whisper of Hunger",type:i.Stasis,bonus:[{stat:a.Mobility,value:-10},{stat:a.Recovery,value:-10}],requiredArmorAffinity:0}};addEventListener("message",({data:r})=>{const i=new Uint16Array(r.permutations),E=r.startPosition,I=r.config;console.time(`WebWorker: Results Builder Helper ${E}`);let l=I.characterClass,T=[0,0,0,0,0,0],O=new Set,f=new Set,S=[];for(let t=0;t<i.length;t+=e.WIDTH){const r=i.subarray(t,t+e.WIDTH);let u=(r[e.EXOTIC_ID_HIBYTE]<<16>>>0)+r[e.EXOTIC_ID_LOBYTE];if(I.selectedExoticHash>0&&u!=I.selectedExoticHash)continue;if(-1==I.selectedExoticHash&&0!=u)continue;if(I.onlyUseMasterworkedItems&&15!=(15&r[e.MASTERWORK_NUMBER]))continue;let R=[(65280&r[e.STATS_MOBILITY_RESILIENCE])>>8,255&r[e.STATS_MOBILITY_RESILIENCE],(65280&r[e.STATS_RECOVERY_DISCIPLINE])>>8,255&r[e.STATS_RECOVERY_DISCIPLINE],(65280&r[e.STATS_INTELLECT_STRENGTH])>>8,255&r[e.STATS_INTELLECT_STRENGTH]];if(I.assumeClassItemMasterworked)for(let e=0;e<6;e++)R[e]+=2;let d=(240&r[e.MASTERWORK_NUMBER])>>4;for(let t=0;t<4;t++){const i=d==4-t;if((r[e.MASTERWORK_NUMBER]&1<<t)>0||!i&&I.assumeLegendariesMasterworked||i&&I.assumeExoticsMasterworked)for(let e=0;e<6;e++)R[e]+=2}for(const e of I.enabledMods)for(const t of o[e].bonus)switch(t.stat){case n.ClassAbilityRegenerationStat:R[[1,0,3][l]]+=t.value;break;default:R[t.stat]+=t.value}let M=R.map((e,t)=>Math.max(0,10*I.minimumStatTier[t]-e)).reduce((e,t,r)=>{if(0==t)return e;let i=t%10>0&&t%10<=5?1:0,s=Math.ceil(Math.max(0,t-5*i)/10);i&&e.push(1+2*r);for(let a=0;a<s;a++)e.push(2*r+1+1);return e},[]);if(M.length>I.maximumStatMods)continue;if(I.tryLimitWastedStats){let e=[R[a.Mobility]+(M.indexOf(s.MINOR_MOBILITY)>-1?5:0),R[a.Resilience]+(M.indexOf(s.MINOR_RESILIENCE)>-1?5:0),R[a.Recovery]+(M.indexOf(s.MINOR_RECOVERY)>-1?5:0),R[a.Discipline]+(M.indexOf(s.MINOR_DISCIPLINE)>-1?5:0),R[a.Intellect]+(M.indexOf(s.MINOR_INTELLECT)>-1?5:0),R[a.Strength]+(M.indexOf(s.MINOR_STRENGTH)>-1?5:0)].map((e,t)=>[e%10,t,e]).sort((e,t)=>t[0]-e[0]);if(M.length<I.maximumStatMods)for(let t=M.length;t<I.maximumStatMods;t++){let t=e.filter(e=>e[2]<100).filter(e=>5==e[0])[0];if(!t)break;t[0]-=5,M.push(1+2*t[1])}if(I.onlyShowResultsWithNoWastedStats&&e.reduce((e,t)=>e+t[0],0)>0)continue}for(let e=0;e<6;e++){let t=Math.min(10,Math.floor(R[e]/10)+(I.maximumStatMods-M.length)+M.filter(t=>Math.floor((t-1)/2)==e).length);T[e]<t&&(T[e]=t)}let _=I.maximumStatMods-M.length;if(_>=0){let e=R.map((e,t)=>e+10*M.filter(e=>Math.floor((e-1)/2)==t).length).map((e,t)=>[Math.max(0,Math.ceil((100-e)/10)),t]).sort((e,t)=>e[0]-t[0]);for(let s in e)for(;_>0&&e[s][0]>0;)_--,e[s][0]--;const t=e.filter(e=>0==e[0]);let r=t.length,i=t.reduce((e,t)=>e+(1<<t[1]),0);3==r&&O.add(i),4==r&&f.add(i)}if(I.tryLimitWastedStats&&M.length<I.maximumStatMods){let e=[R[a.Mobility]+(M.indexOf(s.MINOR_MOBILITY)>-1?5:0),R[a.Resilience]+(M.indexOf(s.MINOR_RESILIENCE)>-1?5:0),R[a.Recovery]+(M.indexOf(s.MINOR_RECOVERY)>-1?5:0),R[a.Discipline]+(M.indexOf(s.MINOR_DISCIPLINE)>-1?5:0),R[a.Intellect]+(M.indexOf(s.MINOR_INTELLECT)>-1?5:0),R[a.Strength]+(M.indexOf(s.MINOR_STRENGTH)>-1?5:0)].map((e,t)=>[e%10,t,e]).sort((e,t)=>t[0]-e[0]);for(let t=M.length;t<I.maximumStatMods;t++){let t=e.filter(e=>e[2]<100).filter(e=>e[0]>5).sort((e,t)=>e[0]-t[0])[0];if(!t)break;t[0]-=5,M.push(1+2*t[1])}}S.push([E+t/e.WIDTH,...M])}const u=new ArrayBuffer(t.WIDTH*S.length),R=new Uint8Array(u);for(let e=0;e<S.length;e++){R[e*t.WIDTH+t.PERMUTATION_ID_BYTE0]=255&S[e][0],R[e*t.WIDTH+t.PERMUTATION_ID_BYTE1]=S[e][0]>>8&255,R[e*t.WIDTH+t.PERMUTATION_ID_BYTE2]=S[e][0]>>16&255,R[e*t.WIDTH+t.PERMUTATION_ID_BYTE3]=S[e][0]>>24&255;for(let r=0;r<6;r++)R[e*t.WIDTH+t.USED_MOD1+r]=S[e][r+1]}console.timeEnd(`WebWorker: Results Builder Helper ${E}`),postMessage({buffer:u,maximumPossibleTiers:T,statCombo3x100:O,statCombo4x100:f},[u])})})();