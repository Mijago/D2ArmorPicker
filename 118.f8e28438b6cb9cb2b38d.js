(()=>{"use strict";var e=(()=>(function(e){e[e.HELMET_ID=0]="HELMET_ID",e[e.GAUNTLET_ID=1]="GAUNTLET_ID",e[e.CHEST_ID=2]="CHEST_ID",e[e.LEG_ID=3]="LEG_ID",e[e.MOBILITY=4]="MOBILITY",e[e.RESILIENCE=5]="RESILIENCE",e[e.RECOVERY=6]="RECOVERY",e[e.DISCIPLINE=7]="DISCIPLINE",e[e.INTELLECT=8]="INTELLECT",e[e.STRENGTH=9]="STRENGTH",e[e.EXOTIC_ID=10]="EXOTIC_ID",e[e.MASTERWORK_NUMBER=11]="MASTERWORK_NUMBER",e[e.ELEMENTAL_AFFINITIES=12]="ELEMENTAL_AFFINITIES",e[e.WIDTH=13]="WIDTH"}(e||(e={})),e))(),t=(()=>(function(e){e[e.PERMUTATION_ID_LOBYTE=0]="PERMUTATION_ID_LOBYTE",e[e.PERMUTATION_ID_HIBYTE=1]="PERMUTATION_ID_HIBYTE",e[e.USED_MOD1=2]="USED_MOD1",e[e.USED_MOD2=3]="USED_MOD2",e[e.USED_MOD3=4]="USED_MOD3",e[e.USED_MOD4=5]="USED_MOD4",e[e.USED_MOD5=6]="USED_MOD5",e[e.WIDTH=7]="WIDTH"}(t||(t={})),t))(),i=(()=>(function(e){e[e.PowerfulFriends=0]="PowerfulFriends",e[e.RadiantLight=1]="RadiantLight",e[e.ProtectiveLight=100]="ProtectiveLight",e[e.ExtraReserves=101]="ExtraReserves",e[e.PrecicelyCharged=102]="PrecicelyCharged",e[e.StacksOnStacks=103]="StacksOnStacks",e[e.PrecisionCharge=104]="PrecisionCharge",e[e.SurpriseAttack=105]="SurpriseAttack",e[e.EnergyConverter=106]="EnergyConverter",e[e.ChargeHarvester=107]="ChargeHarvester",e[e.WhisperOfDurance=1e3]="WhisperOfDurance",e[e.WhisperOfChains=1001]="WhisperOfChains",e[e.WhisperOfConduction=1002]="WhisperOfConduction",e[e.WhisperOfShards=1003]="WhisperOfShards",e[e.WhisperOfHedrons=1100]="WhisperOfHedrons",e[e.WhisperOfBonds=1101]="WhisperOfBonds",e[e.WhisperOfHunger=1102]="WhisperOfHunger",e[e.WhisperOfFractures=1103]="WhisperOfFractures"}(i||(i={})),i))(),r=(()=>(function(e){e[e.CombatStyleMod=0]="CombatStyleMod",e[e.Stasis=1]="Stasis"}(r||(r={})),r))(),s=(()=>(function(e){e[e.NONE=0]="NONE",e[e.MINOR_MOBILITY=1]="MINOR_MOBILITY",e[e.MAJOR_MOBILITY=2]="MAJOR_MOBILITY",e[e.MINOR_RESILIENCE=3]="MINOR_RESILIENCE",e[e.MAJOR_RESILIENCE=4]="MAJOR_RESILIENCE",e[e.MINOR_RECOVERY=5]="MINOR_RECOVERY",e[e.MAJOR_RECOVERY=6]="MAJOR_RECOVERY",e[e.MINOR_DISCIPLINE=7]="MINOR_DISCIPLINE",e[e.MAJOR_DISCIPLINE=8]="MAJOR_DISCIPLINE",e[e.MINOR_INTELLECT=9]="MINOR_INTELLECT",e[e.MAJOR_INTELLECT=10]="MAJOR_INTELLECT",e[e.MINOR_STRENGTH=11]="MINOR_STRENGTH",e[e.MAJOR_STRENGTH=12]="MAJOR_STRENGTH"}(s||(s={})),s))(),n=(()=>(function(e){e[e.Mobility=0]="Mobility",e[e.Resilience=1]="Resilience",e[e.Recovery=2]="Recovery",e[e.Discipline=3]="Discipline",e[e.Intellect=4]="Intellect",e[e.Strength=5]="Strength"}(n||(n={})),n))(),a=(()=>(function(e){e[e.ClassAbilityRegenerationStat=10]="ClassAbilityRegenerationStat"}(a||(a={})),a))();const o={[i.PowerfulFriends]:{id:i.PowerfulFriends,name:"Powerful Friends",type:r.CombatStyleMod,bonus:[{stat:n.Mobility,value:20}],requiredArmorAffinity:1},[i.RadiantLight]:{id:i.RadiantLight,name:"Radiant Light",type:r.CombatStyleMod,bonus:[{stat:n.Strength,value:20}],requiredArmorAffinity:1},[i.ProtectiveLight]:{id:i.ProtectiveLight,name:"Protective Light",type:r.CombatStyleMod,bonus:[{stat:n.Strength,value:-10}],requiredArmorAffinity:3},[i.ExtraReserves]:{id:i.ExtraReserves,name:"Extra Reserves",type:r.CombatStyleMod,bonus:[{stat:n.Intellect,value:-10}],requiredArmorAffinity:3},[i.PrecicelyCharged]:{id:i.PrecicelyCharged,name:"Precicely Charged",type:r.CombatStyleMod,bonus:[{stat:n.Discipline,value:-10}],requiredArmorAffinity:3},[i.StacksOnStacks]:{id:i.StacksOnStacks,name:"Stacks on Stacks",type:r.CombatStyleMod,bonus:[{stat:n.Discipline,value:-10}],requiredArmorAffinity:3},[i.PrecisionCharge]:{id:i.PrecisionCharge,name:"Precision Charge",type:r.CombatStyleMod,bonus:[{stat:n.Strength,value:-10}],requiredArmorAffinity:3},[i.SurpriseAttack]:{id:i.SurpriseAttack,name:"Surprise Attack",type:r.CombatStyleMod,bonus:[{stat:n.Intellect,value:-10}],requiredArmorAffinity:3},[i.EnergyConverter]:{id:i.EnergyConverter,name:"Energy Converter",type:r.CombatStyleMod,bonus:[{stat:n.Discipline,value:-10}],requiredArmorAffinity:3},[i.ChargeHarvester]:{id:i.ChargeHarvester,name:"Charge Harvester",type:r.CombatStyleMod,bonus:[{stat:a.ClassAbilityRegenerationStat,value:-10}],requiredArmorAffinity:3},[i.WhisperOfDurance]:{id:i.WhisperOfDurance,name:"Whisper Of Durance",type:r.Stasis,bonus:[{stat:n.Strength,value:10}],requiredArmorAffinity:0},[i.WhisperOfChains]:{id:i.WhisperOfChains,name:"Whisper Of Chains",type:r.Stasis,bonus:[{stat:n.Recovery,value:10}],requiredArmorAffinity:0},[i.WhisperOfShards]:{id:i.WhisperOfShards,name:"Whisper Of Shards",type:r.Stasis,bonus:[{stat:n.Resilience,value:10}],requiredArmorAffinity:0},[i.WhisperOfConduction]:{id:i.WhisperOfConduction,name:"Whisper Of Conduction",type:r.Stasis,bonus:[{stat:n.Resilience,value:10},{stat:n.Intellect,value:10}],requiredArmorAffinity:0},[i.WhisperOfBonds]:{id:i.WhisperOfBonds,name:"Whisper of Bonds",type:r.Stasis,bonus:[{stat:n.Discipline,value:-10},{stat:n.Intellect,value:-10}],requiredArmorAffinity:0},[i.WhisperOfHedrons]:{id:i.WhisperOfHedrons,name:"Whisper of Hedrons",type:r.Stasis,bonus:[{stat:n.Strength,value:-10}],requiredArmorAffinity:0},[i.WhisperOfFractures]:{id:i.WhisperOfFractures,name:"Whisper of Fractures",type:r.Stasis,bonus:[{stat:n.Discipline,value:-10}],requiredArmorAffinity:0},[i.WhisperOfHunger]:{id:i.WhisperOfHunger,name:"Whisper of Hunger",type:r.Stasis,bonus:[{stat:n.Mobility,value:-10},{stat:n.Recovery,value:-10}],requiredArmorAffinity:0}};addEventListener("message",({data:i})=>{const r=new Uint32Array(i.permutations),l=i.startPosition,f=i.config;console.time(`WebWorker: Results Builder Helper ${l}`);let I=f.characterClass,E=[0,0,0,0,0,0],u=new Set,O=new Set,d=[];for(let t=0;t<r.length;t+=e.WIDTH){const i=r.subarray(t,t+e.WIDTH);if(f.selectedExoticHash>0&&i[e.EXOTIC_ID]!=f.selectedExoticHash)continue;if(-1==f.selectedExoticHash&&0!=i[e.EXOTIC_ID])continue;if(f.onlyUseMasterworkedItems&&15!=i[e.MASTERWORK_NUMBER])continue;let c=[i[4]+2,i[5]+2,i[6]+2,i[7]+2,i[8]+2,i[9]+2];if(f.assumeMasterworked)for(let e=0;e<6;e++)c[e]+=8;else for(let e=0;e<4;e++)if((i[11]&1<<e)>0)for(let t=0;t<6;t++)c[t]+=2;let h=f.selectedArmorAffinities.slice();for(const e of f.enabledMods){0!=o[e].requiredArmorAffinity&&h.unshift(o[e].requiredArmorAffinity);for(const t of o[e].bonus)switch(t.stat){case a.ClassAbilityRegenerationStat:c[[1,0,3][I]]+=t.value;break;default:c[t.stat]+=t.value}}if(!f.ignoreArmorAffinitiesOnMasterworkedItems){h=h.slice(0,5);let e=[];for(let r=0;r<4;r++)(i[11]&1<<r)>0&&e.push(i[12]>>3*r&7);let t=5-e.length;for(let i of h){const r=e.indexOf(i);r>-1?e.splice(r,1):t--}if(t<0)continue}let R=c.map((e,t)=>Math.max(0,10*f.minimumStatTier[t]-e)).reduce((e,t,i)=>{if(0==t)return e;let r=t%10>0&&t%10<=5?1:0,s=Math.ceil(Math.max(0,t-5*r)/10);r&&e.push(1+2*i);for(let n=0;n<s;n++)e.push(2*i+1+1);return e},[]);if(R.length>f.maximumStatMods)continue;if(f.tryLimitWastedStats){let e=[c[n.Mobility]+(R.indexOf(s.MINOR_MOBILITY)>-1?5:0),c[n.Resilience]+(R.indexOf(s.MINOR_RESILIENCE)>-1?5:0),c[n.Recovery]+(R.indexOf(s.MINOR_RECOVERY)>-1?5:0),c[n.Discipline]+(R.indexOf(s.MINOR_DISCIPLINE)>-1?5:0),c[n.Intellect]+(R.indexOf(s.MINOR_INTELLECT)>-1?5:0),c[n.Strength]+(R.indexOf(s.MINOR_STRENGTH)>-1?5:0)].map((e,t)=>[e%10,t,e]).sort((e,t)=>t[0]-e[0]);if(R.length<f.maximumStatMods)for(let t=R.length;t<f.maximumStatMods;t++){let t=e.filter(e=>e[2]<100).filter(e=>5==e[0])[0];if(!t)break;t[0]-=5,R.push(1+2*t[1])}if(f.onlyShowResultsWithNoWastedStats&&e.reduce((e,t)=>e+t[0],0)>0)continue}for(let e=0;e<6;e++){let t=Math.min(10,Math.floor(c[e]/10)+(f.maximumStatMods-R.length)+R.filter(t=>Math.floor((t-1)/2)==e).length);E[e]<t&&(E[e]=t)}let S=f.maximumStatMods-R.length;if(S>=0){let e=c.map((e,t)=>e+10*R.filter(e=>Math.floor((e-1)/2)==t).length).map((e,t)=>[Math.max(0,Math.ceil((100-e)/10)),t]).sort((e,t)=>e[0]-t[0]);for(let s in e)for(;S>0&&e[s][0]>0;)S--,e[s][0]--;const t=e.filter(e=>0==e[0]);let i=t.length,r=t.reduce((e,t)=>e+(1<<t[1]),0);3==i&&u.add(r),4==i&&O.add(r)}if(f.tryLimitWastedStats&&R.length<f.maximumStatMods){let e=[c[n.Mobility]+(R.indexOf(s.MINOR_MOBILITY)>-1?5:0),c[n.Resilience]+(R.indexOf(s.MINOR_RESILIENCE)>-1?5:0),c[n.Recovery]+(R.indexOf(s.MINOR_RECOVERY)>-1?5:0),c[n.Discipline]+(R.indexOf(s.MINOR_DISCIPLINE)>-1?5:0),c[n.Intellect]+(R.indexOf(s.MINOR_INTELLECT)>-1?5:0),c[n.Strength]+(R.indexOf(s.MINOR_STRENGTH)>-1?5:0)].map((e,t)=>[e%10,t,e]).sort((e,t)=>t[0]-e[0]);for(let t=R.length;t<f.maximumStatMods;t++){let t=e.filter(e=>e[2]<100).filter(e=>e[0]>5).sort((e,t)=>e[0]-t[0])[0];if(!t)break;t[0]-=5,R.push(1+2*t[1])}}d.push([l+t/e.WIDTH,...R])}const c=new ArrayBuffer(t.WIDTH*d.length*2),h=new Uint16Array(c);for(let e=0;e<d.length;e++){h[e*t.WIDTH+t.PERMUTATION_ID_LOBYTE]=65535&d[e][0],h[e*t.WIDTH+t.PERMUTATION_ID_HIBYTE]=(-65536&d[e][0])>>16;for(let i=0;i<6;i++)h[e*t.WIDTH+t.USED_MOD1+i]=d[e][i+1]}console.timeEnd(`WebWorker: Results Builder Helper ${l}`),postMessage({buffer:c,maximumPossibleTiers:E,statCombo3x100:u,statCombo4x100:O},[c])})})();