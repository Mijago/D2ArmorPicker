(()=>{"use strict";function e(e,t,n,r,i,s,o){try{var a=e[s](o),l=a.value}catch(c){return void n(c)}a.done?t(l):Promise.resolve(l).then(r,i)}function t(t){return function(){var n=this,r=arguments;return new Promise(function(i,s){var o=t.apply(n,r);function a(t){e(o,i,s,a,l,"next",t)}function l(t){e(o,i,s,a,l,"throw",t)}a(void 0)})}}const n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:global,r=Object.keys,i=Array.isArray;function s(e,t){return"object"!=typeof t||r(t).forEach(function(n){e[n]=t[n]}),e}"undefined"==typeof Promise||n.Promise||(n.Promise=Promise);const o=Object.getPrototypeOf,a={}.hasOwnProperty;function l(e,t){return a.call(e,t)}function c(e,t){"function"==typeof t&&(t=t(o(e))),("undefined"==typeof Reflect?r:Reflect.ownKeys)(t).forEach(n=>{h(e,n,t[n])})}const u=Object.defineProperty;function h(e,t,n,r){u(e,t,s(n&&l(n,"get")&&"function"==typeof n.get?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function f(e){return{from:function(t){return e.prototype=Object.create(t.prototype),h(e.prototype,"constructor",e),{extend:c.bind(null,e.prototype)}}}}const d=Object.getOwnPropertyDescriptor;function m(e,t){let n;return d(e,t)||(n=o(e))&&m(n,t)}const p=[].slice;function y(e,t,n){return p.call(e,t,n)}function g(e,t){return t(e)}function v(e){if(!e)throw new Error("Assertion Failed")}function b(e){n.setImmediate?setImmediate(e):setTimeout(e,0)}function w(e,t){return e.reduce((e,n,r)=>{var i=t(n,r);return i&&(e[i[0]]=i[1]),e},{})}function _(e,t){if(l(e,t))return e[t];if(!t)return e;if("string"!=typeof t){for(var n=[],r=0,i=t.length;r<i;++r){var s=_(e,t[r]);n.push(s)}return n}var o=t.indexOf(".");if(-1!==o){var a=e[t.substr(0,o)];return void 0===a?void 0:_(a,t.substr(o+1))}}function E(e,t,n){if(e&&void 0!==t&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){v("string"!=typeof n&&"length"in n);for(var r=0,s=t.length;r<s;++r)E(e,t[r],n[r])}else{var o=t.indexOf(".");if(-1!==o){var a=t.substr(0,o),l=t.substr(o+1);if(""===l)void 0===n?i(e)&&!isNaN(parseInt(a))?e.splice(a,1):delete e[a]:e[a]=n;else{var c=e[a];c||(c=e[a]={}),E(c,l,n)}}else void 0===n?i(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function S(e){var t={};for(var n in e)l(e,n)&&(t[n]=e[n]);return t}const k=[].concat;function A(e){return k.apply([],e)}const O="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(A([8,16,32,64].map(e=>["Int","Uint","Float"].map(t=>t+e+"Array")))).filter(e=>n[e]),x=O.map(e=>n[e]);w(O,e=>[e,!0]);let C=null;function P(e){C="undefined"!=typeof WeakMap&&new WeakMap;const t=I(e);return C=null,t}function I(e){if(!e||"object"!=typeof e)return e;let t=C&&C.get(e);if(t)return t;if(i(e)){t=[],C&&C.set(e,t);for(var n=0,r=e.length;n<r;++n)t.push(I(e[n]))}else if(x.indexOf(e.constructor)>=0)t=e;else{const n=o(e);for(var s in t=n===Object.prototype?{}:Object.create(n),C&&C.set(e,t),e)l(e,s)&&(t[s]=I(e[s]))}return t}const{toString:M}={};function R(e){return M.call(e).slice(8,-1)}const T="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator",D="symbol"==typeof T?function(e){var t;return null!=e&&(t=e[T])&&t.apply(e)}:function(){return null},N={};function K(e){var t,n,r,s;if(1===arguments.length){if(i(e))return e.slice();if(this===N&&"string"==typeof e)return[e];if(s=D(e)){for(n=[];!(r=s.next()).done;)n.push(r.value);return n}if(null==e)return[e];if("number"==typeof(t=e.length)){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}const B="undefined"!=typeof Symbol?e=>"AsyncFunction"===e[Symbol.toStringTag]:()=>!1;var j="undefined"!=typeof location&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function L(e,t){j=e,q=t}var q=()=>!0;const F=!new Error("").stack;function W(){if(F)try{throw new Error}catch(e){return e}return new Error}function V(e,t){var n=e.stack;return n?(t=t||0,0===n.indexOf(e.name)&&(t+=(e.name+e.message).split("\n").length),n.split("\n").slice(t).filter(q).map(e=>"\n"+e).join("")):""}var H=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],U=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(H),$={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function G(e,t){this._e=W(),this.name=e,this.message=t}function Y(e,t){return e+". Errors: "+Object.keys(t).map(e=>t[e].toString()).filter((e,t,n)=>n.indexOf(e)===t).join("\n")}function z(e,t,n,r){this._e=W(),this.failures=t,this.failedKeys=r,this.successCount=n,this.message=Y(e,t)}function J(e,t){this._e=W(),this.name="BulkError",this.failures=Object.keys(t).map(e=>t[e]),this.failuresByPos=t,this.message=Y(e,t)}f(G).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+V(this._e,2))}},toString:function(){return this.name+": "+this.message}}),f(z).from(G),f(J).from(G);var Q=U.reduce((e,t)=>(e[t]=t+"Error",e),{});const X=G;var Z=U.reduce((e,t)=>{var n=t+"Error";function r(e,r){this._e=W(),this.name=n,e?"string"==typeof e?(this.message=`${e}${r?"\n "+r:""}`,this.inner=r||null):"object"==typeof e&&(this.message=`${e.name} ${e.message}`,this.inner=e):(this.message=$[t]||n,this.inner=null)}return f(r).from(X),e[t]=r,e},{});Z.Syntax=SyntaxError,Z.Type=TypeError,Z.Range=RangeError;var ee=H.reduce((e,t)=>(e[t+"Error"]=Z[t],e),{}),te=U.reduce((e,t)=>(-1===["Syntax","Type","Range"].indexOf(t)&&(e[t+"Error"]=Z[t]),e),{});function ne(){}function re(e){return e}function ie(e,t){return null==e||e===re?t:function(n){return t(e(n))}}function se(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function oe(e,t){return e===ne?t:function(){var n=e.apply(this,arguments);void 0!==n&&(arguments[0]=n);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var s=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?se(r,this.onsuccess):r),i&&(this.onerror=this.onerror?se(i,this.onerror):i),void 0!==s?s:n}}function ae(e,t){return e===ne?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?se(n,this.onsuccess):n),r&&(this.onerror=this.onerror?se(r,this.onerror):r)}}function le(e,t){return e===ne?t:function(n){var r=e.apply(this,arguments);s(n,r);var i=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var a=t.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?se(i,this.onsuccess):i),o&&(this.onerror=this.onerror?se(o,this.onerror):o),void 0===r?void 0===a?void 0:a:s(r,a)}}function ce(e,t){return e===ne?t:function(){return!1!==t.apply(this,arguments)&&e.apply(this,arguments)}}function ue(e,t){return e===ne?t:function(){var n=e.apply(this,arguments);if(n&&"function"==typeof n.then){for(var r=this,i=arguments.length,s=new Array(i);i--;)s[i]=arguments[i];return n.then(function(){return t.apply(r,s)})}return t.apply(this,arguments)}}te.ModifyError=z,te.DexieError=G,te.BulkError=J;var he={};const[fe,de,me]="undefined"==typeof Promise?[]:(()=>{let e=Promise.resolve();if("undefined"==typeof crypto||!crypto.subtle)return[e,o(e),e];const t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,o(t),e]})(),pe=de&&de.then,ye=fe&&fe.constructor,ge=!!me;var ve=!1,be=me?()=>{me.then(We)}:n.setImmediate?setImmediate.bind(null,We):n.MutationObserver?()=>{var e=document.createElement("div");new MutationObserver(()=>{We(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:()=>{setTimeout(We,0)},we=function(e,t){Pe.push([e,t]),Ee&&(be(),Ee=!1)},_e=!0,Ee=!0,Se=[],ke=[],Ae=null,Oe=re,xe={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:dt,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(e=>{try{dt(e[0],e[1])}catch(t){}})}},Ce=xe,Pe=[],Ie=0,Me=[];function Re(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=ne,this._lib=!1;var t=this._PSD=Ce;if(j&&(this._stackHolder=W(),this._prev=null,this._numPrev=0),"function"!=typeof e){if(e!==he)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(!1===this._state&&Ke(this,this._value))}this._state=null,this._value=null,++t.ref,Ne(this,e)}const Te={get:function(){var e=Ce,t=Xe;function n(n,r){var i=!e.global&&(e!==Ce||t!==Xe);const s=i&&!nt();var o=new Re((t,o)=>{je(this,new De(ut(n,e,i,s),ut(r,e,i,s),t,o,e))});return j&&Fe(o,this),o}return n.prototype=he,n},set:function(e){h(this,"then",e&&e.prototype===he?Te:{get:function(){return e},set:Te.set})}};function De(e,t,n,r,i){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=r,this.psd=i}function Ne(e,t){try{t(t=>{if(null===e._state){if(t===e)throw new TypeError("A promise cannot be resolved with itself.");var n=e._lib&&Ve();t&&"function"==typeof t.then?Ne(e,(e,n)=>{t instanceof Re?t._then(e,n):t.then(e,n)}):(e._state=!0,e._value=t,Be(e)),n&&He()}},Ke.bind(null,e))}catch(n){Ke(e,n)}}function Ke(e,t){if(ke.push(t),null===e._state){var n=e._lib&&Ve();t=Oe(t),e._state=!1,e._value=t,j&&null!==t&&"object"==typeof t&&!t._promise&&function(n,r,i){try{(()=>{var n=m(t,"stack");t._promise=e,h(t,"stack",{get:()=>ve?n&&(n.get?n.get.apply(t):n.value):e.stack})}).apply(null,void 0)}catch(s){}}(),function(e){Se.some(t=>t._value===e._value)||Se.push(e)}(e),Be(e),n&&He()}}function Be(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)je(e,t[n]);var i=e._PSD;--i.ref||i.finalize(),0===Ie&&(++Ie,we(()=>{0==--Ie&&Ue()},[]))}function je(e,t){if(null!==e._state){var n=e._state?t.onFulfilled:t.onRejected;if(null===n)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Ie,we(Le,[n,e,t])}else e._listeners.push(t)}function Le(e,t,n){try{Ae=t;var r,i=t._value;t._state?r=e(i):(ke.length&&(ke=[]),r=e(i),-1===ke.indexOf(i)&&function(e){for(var t=Se.length;t;)if(Se[--t]._value===e._value)return void Se.splice(t,1)}(t)),n.resolve(r)}catch(s){n.reject(s)}finally{Ae=null,0==--Ie&&Ue(),--n.psd.ref||n.psd.finalize()}}function qe(e,t,n){if(t.length===n)return t;var r="";if(!1===e._state){var i,s,o=e._value;null!=o?(i=o.name||"Error",s=o.message||o,r=V(o,0)):(i=o,s=""),t.push(i+(s?": "+s:"")+r)}return j&&((r=V(e._stackHolder,2))&&-1===t.indexOf(r)&&t.push(r),e._prev&&qe(e._prev,t,n)),t}function Fe(e,t){var n=t?t._numPrev+1:0;n<100&&(e._prev=t,e._numPrev=n)}function We(){Ve()&&He()}function Ve(){var e=_e;return _e=!1,Ee=!1,e}function He(){var e,t,n;do{for(;Pe.length>0;)for(e=Pe,Pe=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}}while(Pe.length>0);_e=!0,Ee=!0}function Ue(){var e=Se;Se=[],e.forEach(e=>{e._PSD.onunhandled.call(null,e._value,e)});for(var t=Me.slice(0),n=t.length;n;)t[--n]()}function $e(e){return new Re(he,!1,e)}function Ge(e,t){var n=Ce;return function(){var r=Ve(),i=Ce;try{return ot(n,!0),e.apply(this,arguments)}catch(s){t&&t(s)}finally{ot(i,!1),r&&He()}}}c(Re.prototype,{then:Te,_then:function(e,t){je(this,new De(null,null,e,t,Ce))},catch:function(e){if(1===arguments.length)return this.then(null,e);var t=arguments[0],n=arguments[1];return this.then(null,"function"==typeof t?e=>e instanceof t?n(e):$e(e):e=>e&&e.name===t?n(e):$e(e))},finally:function(e){return this.then(t=>(e(),t),t=>(e(),$e(t)))},stack:{get:function(){if(this._stack)return this._stack;try{ve=!0;var e=qe(this,[],20).join("\nFrom previous: ");return null!==this._state&&(this._stack=e),e}finally{ve=!1}}},timeout:function(e,t){return e<1/0?new Re((n,r)=>{var i=setTimeout(()=>r(new Z.Timeout(t)),e);this.then(n,r).finally(clearTimeout.bind(null,i))}):this}}),"undefined"!=typeof Symbol&&Symbol.toStringTag&&h(Re.prototype,Symbol.toStringTag,"Dexie.Promise"),xe.env=at(),c(Re,{all:function(){var e=K.apply(null,arguments).map(rt);return new Re(function(t,n){0===e.length&&t([]);var r=e.length;e.forEach((i,s)=>Re.resolve(i).then(n=>{e[s]=n,--r||t(e)},n))})},resolve:e=>{if(e instanceof Re)return e;if(e&&"function"==typeof e.then)return new Re((t,n)=>{e.then(t,n)});var t=new Re(he,!0,e);return Fe(t,Ae),t},reject:$e,race:function(){var e=K.apply(null,arguments).map(rt);return new Re((t,n)=>{e.map(e=>Re.resolve(e).then(t,n))})},PSD:{get:()=>Ce,set:e=>Ce=e},totalEchoes:{get:()=>Xe},newPSD:et,usePSD:lt,scheduler:{get:()=>we,set:e=>{we=e}},rejectionMapper:{get:()=>Oe,set:e=>{Oe=e}},follow:(e,t)=>new Re((n,r)=>et((t,n)=>{var r=Ce;r.unhandleds=[],r.onunhandled=n,r.finalize=se(function(){!function(e){Me.push(function t(){e(),Me.splice(Me.indexOf(t),1)}),++Ie,we(()=>{0==--Ie&&Ue()},[])}(()=>{0===this.unhandleds.length?t():n(this.unhandleds[0])})},r.finalize),e()},t,n,r))}),ye&&(ye.allSettled&&h(Re,"allSettled",function(){const e=K.apply(null,arguments).map(rt);return new Re(t=>{0===e.length&&t([]);let n=e.length;const r=new Array(n);e.forEach((e,i)=>Re.resolve(e).then(e=>r[i]={status:"fulfilled",value:e},e=>r[i]={status:"rejected",reason:e}).then(()=>--n||t(r)))})}),ye.any&&"undefined"!=typeof AggregateError&&h(Re,"any",function(){const e=K.apply(null,arguments).map(rt);return new Re((t,n)=>{0===e.length&&n(new AggregateError([]));let r=e.length;const i=new Array(r);e.forEach((e,s)=>Re.resolve(e).then(e=>t(e),e=>{i[s]=e,--r||n(new AggregateError(i))}))})}));const Ye={awaits:0,echoes:0,id:0};var ze=0,Je=[],Qe=0,Xe=0,Ze=0;function et(e,t,n,r){var i=Ce,o=Object.create(i);o.parent=i,o.ref=0,o.global=!1,o.id=++Ze;var a=xe.env;o.env=ge?{Promise:Re,PromiseProp:{value:Re,configurable:!0,writable:!0},all:Re.all,race:Re.race,allSettled:Re.allSettled,any:Re.any,resolve:Re.resolve,reject:Re.reject,nthen:ht(a.nthen,o),gthen:ht(a.gthen,o)}:{},t&&s(o,t),++i.ref,o.finalize=function(){--this.parent.ref||this.parent.finalize()};var l=lt(o,e,n,r);return 0===o.ref&&o.finalize(),l}function tt(){return Ye.id||(Ye.id=++ze),++Ye.awaits,Ye.echoes+=100,Ye.id}function nt(){return!!Ye.awaits&&(0==--Ye.awaits&&(Ye.id=0),Ye.echoes=100*Ye.awaits,!0)}function rt(e){return Ye.echoes&&e&&e.constructor===ye?(tt(),e.then(e=>(nt(),e),e=>(nt(),mt(e)))):e}function it(e){++Xe,Ye.echoes&&0!=--Ye.echoes||(Ye.echoes=Ye.id=0),Je.push(Ce),ot(e,!0)}function st(){var e=Je[Je.length-1];Je.pop(),ot(e,!1)}function ot(e,t){var r=Ce;if((t?!Ye.echoes||Qe++&&e===Ce:!Qe||--Qe&&e===Ce)||ct(t?it.bind(null,e):st),e!==Ce&&(Ce=e,r===xe&&(xe.env=at()),ge)){var i=xe.env.Promise,s=e.env;de.then=s.nthen,i.prototype.then=s.gthen,(r.global||e.global)&&(Object.defineProperty(n,"Promise",s.PromiseProp),i.all=s.all,i.race=s.race,i.resolve=s.resolve,i.reject=s.reject,s.allSettled&&(i.allSettled=s.allSettled),s.any&&(i.any=s.any))}}function at(){var e=n.Promise;return ge?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(n,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:de.then,gthen:e.prototype.then}:{}}function lt(e,t,n,r,i){var s=Ce;try{return ot(e,!0),t(n,r,i)}finally{ot(s,!1)}}function ct(e){pe.call(fe,e)}function ut(e,t,n,r){return"function"!=typeof e?e:function(){var i=Ce;n&&tt(),ot(t,!0);try{return e.apply(this,arguments)}finally{ot(i,!1),r&&ct(nt)}}}function ht(e,t){return function(n,r){return e.call(this,ut(n,t),ut(r,t))}}-1===(""+pe).indexOf("[native code]")&&(tt=nt=ne);const ft="unhandledrejection";function dt(e,t){var r;try{r=t.onuncatched(e)}catch(a){}if(!1!==r)try{var i,o={promise:t,reason:e};if(n.document&&document.createEvent?((i=document.createEvent("Event")).initEvent(ft,!0,!0),s(i,o)):n.CustomEvent&&s(i=new CustomEvent(ft,{detail:o}),o),i&&n.dispatchEvent&&(dispatchEvent(i),!n.PromiseRejectionEvent&&n.onunhandledrejection))try{n.onunhandledrejection(i)}catch(l){}j&&i&&!i.defaultPrevented&&console.warn(`Unhandled rejection: ${e.stack||e}`)}catch(a){}}var mt=Re.reject;function pt(e,t,n,r){if(e.idbdb&&(e._state.openComplete||Ce.letThrough||e._vip)){var i=e._createTransaction(t,n,e._dbSchema);try{i.create()}catch(s){return mt(s)}return i._promise(t,(e,t)=>et(()=>(Ce.trans=i,r(e,t,i)))).then(e=>i._completion.then(()=>e))}if(e._state.openComplete)return mt(new Z.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._options.autoOpen)return mt(new Z.DatabaseClosed);e.open().catch(ne)}return e._state.dbReadyPromise.then(()=>pt(e,t,n,r))}const yt="3.2.0",gt=String.fromCharCode(65535),vt=-1/0,bt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",wt="String expected.",_t=[],Et="undefined"!=typeof navigator&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),St=Et,kt=Et,At=e=>!/(dexie\.js|dexie\.min\.js)/.test(e),Ot="__dbnames",xt="readonly",Ct="readwrite";function Pt(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}const It={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Mt(e){return"string"!=typeof e||/\./.test(e)?e=>e:t=>(void 0===t[e]&&e in t&&delete(t=P(t))[e],t)}class Rt{_trans(e,t,n){const r=this._tx||Ce.trans,i=this.name;function s(e,n,r){if(!r.schema[i])throw new Z.NotFound("Table "+i+" not part of transaction");return t(r.idbtrans,r)}const o=Ve();try{return r&&r.db===this.db?r===Ce.trans?r._promise(e,s,n):et(()=>r._promise(e,s,n),{trans:r,transless:Ce.transless||Ce}):pt(this.db,e,[this.name],s)}finally{o&&He()}}get(e,t){return e&&e.constructor===Object?this.where(e).first(t):this._trans("readonly",t=>this.core.get({trans:t,key:e}).then(e=>this.hook.reading.fire(e))).then(t)}where(e){if("string"==typeof e)return new this.db.WhereClause(this,e);if(i(e))return new this.db.WhereClause(this,`[${e.join("+")}]`);const t=r(e);if(1===t.length)return this.where(t[0]).equals(e[t[0]]);const n=this.schema.indexes.concat(this.schema.primKey).filter(e=>e.compound&&t.every(t=>e.keyPath.indexOf(t)>=0)&&e.keyPath.every(e=>t.indexOf(e)>=0))[0];if(n&&this.db._maxKey!==gt)return this.where(n.name).equals(n.keyPath.map(t=>e[t]));!n&&j&&console.warn(`The query ${JSON.stringify(e)} on ${this.name} would benefit of a compound index [${t.join("+")}]`);const{idxByName:s}=this.schema,o=this.db._deps.indexedDB;function a(e,t){try{return 0===o.cmp(e,t)}catch(n){return!1}}const[l,c]=t.reduce(([t,n],r)=>{const o=s[r],l=e[r];return[t||o,t||!o?Pt(n,o&&o.multi?e=>{const t=_(e,r);return i(t)&&t.some(e=>a(l,e))}:e=>a(l,_(e,r))):n]},[null,null]);return l?this.where(l.name).equals(e[l.keyPath]).filter(c):n?this.filter(c):this.where(t).equals("")}filter(e){return this.toCollection().and(e)}count(e){return this.toCollection().count(e)}offset(e){return this.toCollection().offset(e)}limit(e){return this.toCollection().limit(e)}each(e){return this.toCollection().each(e)}toArray(e){return this.toCollection().toArray(e)}toCollection(){return new this.db.Collection(new this.db.WhereClause(this))}orderBy(e){return new this.db.Collection(new this.db.WhereClause(this,i(e)?`[${e.join("+")}]`:e))}reverse(){return this.toCollection().reverse()}mapToClass(e){this.schema.mappedClass=e;const t=t=>{if(!t)return t;const n=Object.create(e.prototype);for(var r in t)if(l(t,r))try{n[r]=t[r]}catch(i){}return n};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=t,this.hook("reading",t),e}defineClass(){return this.mapToClass(function(e){s(this,e)})}add(e,t){const{auto:n,keyPath:r}=this.schema.primKey;let i=e;return r&&n&&(i=Mt(r)(e)),this._trans("readwrite",e=>this.core.mutate({trans:e,type:"add",keys:null!=t?[t]:null,values:[i]})).then(e=>e.numFailures?Re.reject(e.failures[0]):e.lastResult).then(t=>{if(r)try{E(e,r,t)}catch(n){}return t})}update(e,t){if("object"!=typeof e||i(e))return this.where(":id").equals(e).modify(t);{const i=_(e,this.schema.primKey.keyPath);if(void 0===i)return mt(new Z.InvalidArgument("Given object does not contain its primary key"));try{"function"!=typeof t?r(t).forEach(n=>{E(e,n,t[n])}):t(e,{value:e,primKey:i})}catch(n){}return this.where(":id").equals(i).modify(t)}}put(e,t){const{auto:n,keyPath:r}=this.schema.primKey;let i=e;return r&&n&&(i=Mt(r)(e)),this._trans("readwrite",e=>this.core.mutate({trans:e,type:"put",values:[i],keys:null!=t?[t]:null})).then(e=>e.numFailures?Re.reject(e.failures[0]):e.lastResult).then(t=>{if(r)try{E(e,r,t)}catch(n){}return t})}delete(e){return this._trans("readwrite",t=>this.core.mutate({trans:t,type:"delete",keys:[e]})).then(e=>e.numFailures?Re.reject(e.failures[0]):void 0)}clear(){return this._trans("readwrite",e=>this.core.mutate({trans:e,type:"deleteRange",range:It})).then(e=>e.numFailures?Re.reject(e.failures[0]):void 0)}bulkGet(e){return this._trans("readonly",t=>this.core.getMany({keys:e,trans:t}).then(e=>e.map(e=>this.hook.reading.fire(e))))}bulkAdd(e,t,n){const r=Array.isArray(t)?t:void 0,i=(n=n||(r?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",t=>{const{auto:n,keyPath:s}=this.schema.primKey;if(s&&r)throw new Z.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(r&&r.length!==e.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");const o=e.length;let a=s&&n?e.map(Mt(s)):e;return this.core.mutate({trans:t,type:"add",keys:r,values:a,wantResults:i}).then(({numFailures:e,results:t,lastResult:n,failures:r})=>{if(0===e)return i?t:n;throw new J(`${this.name}.bulkAdd(): ${e} of ${o} operations failed`,r)})})}bulkPut(e,t,n){const r=Array.isArray(t)?t:void 0,i=(n=n||(r?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",t=>{const{auto:n,keyPath:s}=this.schema.primKey;if(s&&r)throw new Z.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(r&&r.length!==e.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");const o=e.length;let a=s&&n?e.map(Mt(s)):e;return this.core.mutate({trans:t,type:"put",keys:r,values:a,wantResults:i}).then(({numFailures:e,results:t,lastResult:n,failures:r})=>{if(0===e)return i?t:n;throw new J(`${this.name}.bulkPut(): ${e} of ${o} operations failed`,r)})})}bulkDelete(e){const t=e.length;return this._trans("readwrite",t=>this.core.mutate({trans:t,type:"delete",keys:e})).then(({numFailures:e,lastResult:n,failures:r})=>{if(0===e)return n;throw new J(`${this.name}.bulkDelete(): ${e} of ${t} operations failed`,r)})}}function Tt(e){var t={},n=function(n,r){if(r){for(var i=arguments.length,s=new Array(i-1);--i;)s[i-1]=arguments[i];return t[n].subscribe.apply(null,s),e}if("string"==typeof n)return t[n]};n.addEventType=a;for(var s=1,o=arguments.length;s<o;++s)a(arguments[s]);return n;function a(e,r,i){if("object"==typeof e)return l(e);r||(r=ce),i||(i=ne);var s={subscribers:[],fire:i,subscribe:function(e){-1===s.subscribers.indexOf(e)&&(s.subscribers.push(e),s.fire=r(s.fire,e))},unsubscribe:function(e){s.subscribers=s.subscribers.filter(function(t){return t!==e}),s.fire=s.subscribers.reduce(r,i)}};return t[e]=n[e]=s,s}function l(e){r(e).forEach(function(t){var n=e[t];if(i(n))a(t,e[t][0],e[t][1]);else{if("asap"!==n)throw new Z.InvalidArgument("Invalid event config");var r=a(t,re,function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];r.subscribers.forEach(function(e){b(function(){e.apply(null,t)})})})}})}}function Dt(e,t){return f(t).from({prototype:e}),t}function Nt(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Kt(e,t){e.filter=Pt(e.filter,t)}function Bt(e,t,n){var r=e.replayFilter;e.replayFilter=r?()=>Pt(r(),t()):t,e.justLimit=n&&!r}function jt(e,t){if(e.isPrimKey)return t.primaryKey;const n=t.getIndexByKeyPath(e.index);if(!n)throw new Z.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return n}function Lt(e,t,n){const r=jt(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:"prev"===e.dir,unique:!!e.unique,query:{index:r,range:e.range}})}function qt(e,t,n,r){const i=e.replayFilter?Pt(e.filter,e.replayFilter()):e.filter;if(e.or){const s={},o=(e,n,r)=>{if(!i||i(n,r,e=>n.stop(e),e=>n.fail(e))){var o=n.primaryKey,a=""+o;"[object ArrayBuffer]"===a&&(a=""+new Uint8Array(o)),l(s,a)||(s[a]=!0,t(e,n,r))}};return Promise.all([e.or._iterate(o,n),Ft(Lt(e,r,n),e.algorithm,o,!e.keysOnly&&e.valueMapper)])}return Ft(Lt(e,r,n),Pt(e.algorithm,i),t,!e.keysOnly&&e.valueMapper)}function Ft(e,t,n,r){var i=Ge(r?(e,t,i)=>n(r(e),t,i):n);return e.then(e=>{if(e)return e.start(()=>{var n=()=>e.continue();t&&!t(e,e=>n=e,t=>{e.stop(t),n=ne},t=>{e.fail(t),n=ne})||i(e.value,e,e=>n=e),n()})})}function Wt(e,t){try{const n=Vt(e),r=Vt(t);if(n!==r)return"Array"===n?1:"Array"===r?-1:"binary"===n?1:"binary"===r?-1:"string"===n?1:"string"===r?-1:"Date"===n?1:"Date"!==r?NaN:-1;switch(n){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return function(e,t){const n=e.length,r=t.length,i=n<r?n:r;for(let s=0;s<i;++s)if(e[s]!==t[s])return e[s]<t[s]?-1:1;return n===r?0:n<r?-1:1}(Ht(e),Ht(t));case"Array":return function(e,t){const n=e.length,r=t.length,i=n<r?n:r;for(let s=0;s<i;++s){const n=Wt(e[s],t[s]);if(0!==n)return n}return n===r?0:n<r?-1:1}(e,t)}}catch(n){}return NaN}function Vt(e){const t=typeof e;if("object"!==t)return t;if(ArrayBuffer.isView(e))return"binary";const n=R(e);return"ArrayBuffer"===n?"binary":n}function Ht(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}class Ut{_read(e,t){var n=this._ctx;return n.error?n.table._trans(null,mt.bind(null,n.error)):n.table._trans("readonly",e).then(t)}_write(e){var t=this._ctx;return t.error?t.table._trans(null,mt.bind(null,t.error)):t.table._trans("readwrite",e,"locked")}_addAlgorithm(e){var t=this._ctx;t.algorithm=Pt(t.algorithm,e)}_iterate(e,t){return qt(this._ctx,e,t,this._ctx.table.core)}clone(e){var t=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return e&&s(n,e),t._ctx=n,t}raw(){return this._ctx.valueMapper=null,this}each(e){var t=this._ctx;return this._read(n=>qt(t,e,n,t.table.core))}count(e){return this._read(e=>{const t=this._ctx,n=t.table.core;if(Nt(t,!0))return n.count({trans:e,query:{index:jt(t,n.schema),range:t.range}}).then(e=>Math.min(e,t.limit));var r=0;return qt(t,()=>(++r,!1),e,n).then(()=>r)}).then(e)}sortBy(e,t){const n=e.split(".").reverse(),r=n[0],i=n.length-1;function s(e,t){return t?s(e[n[t]],t-1):e[r]}var o="next"===this._ctx.dir?1:-1;function a(e,t){var n=s(e,i),r=s(t,i);return n<r?-o:n>r?o:0}return this.toArray(function(e){return e.sort(a)}).then(t)}toArray(e){return this._read(e=>{var t=this._ctx;if("next"===t.dir&&Nt(t,!0)&&t.limit>0){const{valueMapper:n}=t,r=jt(t,t.table.core.schema);return t.table.core.query({trans:e,limit:t.limit,values:!0,query:{index:r,range:t.range}}).then(({result:e})=>n?e.map(n):e)}{const n=[];return qt(t,e=>n.push(e),e,t.table.core).then(()=>n)}},e)}offset(e){var t=this._ctx;return e<=0||(t.offset+=e,Nt(t)?Bt(t,()=>{var t=e;return(e,n)=>0===t||(1===t?(--t,!1):(n(()=>{e.advance(t),t=0}),!1))}):Bt(t,()=>{var t=e;return()=>--t<0})),this}limit(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Bt(this._ctx,()=>{var t=e;return function(e,n,r){return--t<=0&&n(r),t>=0}},!0),this}until(e,t){return Kt(this._ctx,function(n,r,i){return!e(n.value)||(r(i),t)}),this}first(e){return this.limit(1).toArray(function(e){return e[0]}).then(e)}last(e){return this.reverse().first(e)}filter(e){var t;return Kt(this._ctx,function(t){return e(t.value)}),(t=this._ctx).isMatch=Pt(t.isMatch,e),this}and(e){return this.filter(e)}or(e){return new this.db.WhereClause(this._ctx.table,e,this)}reverse(){return this._ctx.dir="prev"===this._ctx.dir?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this}desc(){return this.reverse()}eachKey(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(t,n){e(n.key,n)})}eachUniqueKey(e){return this._ctx.unique="unique",this.eachKey(e)}eachPrimaryKey(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(t,n){e(n.primaryKey,n)})}keys(e){var t=this._ctx;t.keysOnly=!t.isMatch;var n=[];return this.each(function(e,t){n.push(t.key)}).then(function(){return n}).then(e)}primaryKeys(e){var t=this._ctx;if("next"===t.dir&&Nt(t,!0)&&t.limit>0)return this._read(e=>{var n=jt(t,t.table.core.schema);return t.table.core.query({trans:e,values:!1,limit:t.limit,query:{index:n,range:t.range}})}).then(({result:e})=>e).then(e);t.keysOnly=!t.isMatch;var n=[];return this.each(function(e,t){n.push(t.primaryKey)}).then(function(){return n}).then(e)}uniqueKeys(e){return this._ctx.unique="unique",this.keys(e)}firstKey(e){return this.limit(1).keys(function(e){return e[0]}).then(e)}lastKey(e){return this.reverse().firstKey(e)}distinct(){var e=this._ctx,t=e.index&&e.table.schema.idxByName[e.index];if(!t||!t.multi)return this;var n={};return Kt(this._ctx,function(e){var t=e.primaryKey.toString(),r=l(n,t);return n[t]=!0,!r}),this}modify(e){var t=this._ctx;return this._write(n=>{var i;if("function"==typeof e)i=e;else{var s=r(e),o=s.length;i=function(t){for(var n=!1,r=0;r<o;++r){var i=s[r],a=e[i];_(t,i)!==a&&(E(t,i,a),n=!0)}return n}}const a=t.table.core,{outbound:l,extractKey:c}=a.schema.primaryKey,u=this.db._options.modifyChunkSize||200,h=[];let f=0;const d=[],m=(e,t)=>{const{failures:n,numFailures:i}=t;f+=e-i;for(let s of r(n))h.push(n[s])};return this.clone().primaryKeys().then(r=>{const s=o=>{const h=Math.min(u,r.length-o);return a.getMany({trans:n,keys:r.slice(o,o+h),cache:"immutable"}).then(f=>{const d=[],p=[],y=l?[]:null,g=[];for(let e=0;e<h;++e){const t=f[e],n={value:P(t),primKey:r[o+e]};!1!==i.call(n,n.value,n)&&(null==n.value?g.push(r[o+e]):l||0===Wt(c(t),c(n.value))?(p.push(n.value),l&&y.push(r[o+e])):(g.push(r[o+e]),d.push(n.value)))}const v=Nt(t)&&t.limit===1/0&&("function"!=typeof e||e===$t)&&{index:t.index,range:t.range};return Promise.resolve(d.length>0&&a.mutate({trans:n,type:"add",values:d}).then(e=>{for(let t in e.failures)g.splice(parseInt(t),1);m(d.length,e)})).then(()=>(p.length>0||v&&"object"==typeof e)&&a.mutate({trans:n,type:"put",keys:y,values:p,criteria:v,changeSpec:"function"!=typeof e&&e}).then(e=>m(p.length,e))).then(()=>(g.length>0||v&&e===$t)&&a.mutate({trans:n,type:"delete",keys:g,criteria:v}).then(e=>m(g.length,e))).then(()=>r.length>o+h&&s(o+u))})};return s(0).then(()=>{if(h.length>0)throw new z("Error modifying one or more objects",h,f,d);return r.length})})})}delete(){var e=this._ctx,t=e.range;return Nt(e)&&(e.isPrimKey&&!kt||3===t.type)?this._write(n=>{const{primaryKey:r}=e.table.core.schema,i=t;return e.table.core.count({trans:n,query:{index:r,range:i}}).then(t=>e.table.core.mutate({trans:n,type:"deleteRange",range:i}).then(({failures:e,numFailures:n})=>{if(n)throw new z("Could not delete some values",Object.keys(e).map(t=>e[t]),t-n);return t-n}))}):this.modify($t)}}const $t=(e,t)=>t.value=null;function Gt(e,t){return e<t?-1:e===t?0:1}function Yt(e,t){return e>t?-1:e===t?0:1}function zt(e,t,n){var r=e instanceof tn?new e.Collection(e):e;return r._ctx.error=n?new n(t):new TypeError(t),r}function Jt(e){return new e.Collection(e,()=>en("")).limit(0)}function Qt(e,t,n,r,i,s){for(var o=Math.min(e.length,r.length),a=-1,l=0;l<o;++l){var c=t[l];if(c!==r[l])return i(e[l],n[l])<0?e.substr(0,l)+n[l]+n.substr(l+1):i(e[l],r[l])<0?e.substr(0,l)+r[l]+n.substr(l+1):a>=0?e.substr(0,a)+t[a]+n.substr(a+1):null;i(e[l],c)<0&&(a=l)}return o<r.length&&"next"===s?e+n.substr(e.length):o<e.length&&"prev"===s?e.substr(0,n.length):a<0?null:e.substr(0,a)+r[a]+n.substr(a+1)}function Xt(e,t,n,r){var i,s,o,a,l,c,u,h=n.length;if(!n.every(e=>"string"==typeof e))return zt(e,wt);function f(e){i=function(e){return"next"===e?e=>e.toUpperCase():e=>e.toLowerCase()}(e),s=function(e){return"next"===e?e=>e.toLowerCase():e=>e.toUpperCase()}(e),o="next"===e?Gt:Yt;var t=n.map(function(e){return{lower:s(e),upper:i(e)}}).sort(function(e,t){return o(e.lower,t.lower)});a=t.map(function(e){return e.upper}),l=t.map(function(e){return e.lower}),c=e,u="next"===e?"":r}f("next");var d=new e.Collection(e,()=>Zt(a[0],l[h-1]+r));d._ondirectionchange=function(e){f(e)};var m=0;return d._addAlgorithm(function(e,n,r){var i=e.key;if("string"!=typeof i)return!1;var f=s(i);if(t(f,l,m))return!0;for(var d=null,p=m;p<h;++p){var y=Qt(i,f,a[p],l[p],o,c);null===y&&null===d?m=p+1:(null===d||o(d,y)>0)&&(d=y)}return n(null!==d?function(){e.continue(d+u)}:r),!1}),d}function Zt(e,t,n,r){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:r}}function en(e){return{type:1,lower:e,upper:e}}class tn{get Collection(){return this._ctx.table.db.Collection}between(e,t,n,r){n=!1!==n,r=!0===r;try{return this._cmp(e,t)>0||0===this._cmp(e,t)&&(n||r)&&(!n||!r)?Jt(this):new this.Collection(this,()=>Zt(e,t,!n,!r))}catch(i){return zt(this,bt)}}equals(e){return null==e?zt(this,bt):new this.Collection(this,()=>en(e))}above(e){return null==e?zt(this,bt):new this.Collection(this,()=>Zt(e,void 0,!0))}aboveOrEqual(e){return null==e?zt(this,bt):new this.Collection(this,()=>Zt(e,void 0,!1))}below(e){return null==e?zt(this,bt):new this.Collection(this,()=>Zt(void 0,e,!1,!0))}belowOrEqual(e){return null==e?zt(this,bt):new this.Collection(this,()=>Zt(void 0,e))}startsWith(e){return"string"!=typeof e?zt(this,wt):this.between(e,e+gt,!0,!0)}startsWithIgnoreCase(e){return""===e?this.startsWith(e):Xt(this,(e,t)=>0===e.indexOf(t[0]),[e],gt)}equalsIgnoreCase(e){return Xt(this,(e,t)=>e===t[0],[e],"")}anyOfIgnoreCase(){var e=K.apply(N,arguments);return 0===e.length?Jt(this):Xt(this,(e,t)=>-1!==t.indexOf(e),e,"")}startsWithAnyOfIgnoreCase(){var e=K.apply(N,arguments);return 0===e.length?Jt(this):Xt(this,(e,t)=>t.some(t=>0===e.indexOf(t)),e,gt)}anyOf(){const e=K.apply(N,arguments);let t=this._cmp;try{e.sort(t)}catch(i){return zt(this,bt)}if(0===e.length)return Jt(this);const n=new this.Collection(this,()=>Zt(e[0],e[e.length-1]));n._ondirectionchange=n=>{t="next"===n?this._ascending:this._descending,e.sort(t)};let r=0;return n._addAlgorithm((n,i,s)=>{const o=n.key;for(;t(o,e[r])>0;)if(++r,r===e.length)return i(s),!1;return 0===t(o,e[r])||(i(()=>{n.continue(e[r])}),!1)}),n}notEqual(e){return this.inAnyRange([[vt,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const e=K.apply(N,arguments);if(0===e.length)return new this.Collection(this);try{e.sort(this._ascending)}catch(n){return zt(this,bt)}const t=e.reduce((e,t)=>e?e.concat([[e[e.length-1][1],t]]):[[vt,t]],null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})}inAnyRange(e,t){const n=this._cmp,r=this._ascending,i=this._descending,s=this._min,o=this._max;if(0===e.length)return Jt(this);if(!e.every(e=>void 0!==e[0]&&void 0!==e[1]&&r(e[0],e[1])<=0))return zt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",Z.InvalidArgument);const a=!t||!1!==t.includeLowers,l=t&&!0===t.includeUppers;let c,u=r;function h(e,t){return u(e[0],t[0])}try{c=e.reduce(function(e,t){let r=0,i=e.length;for(;r<i;++r){const i=e[r];if(n(t[0],i[1])<0&&n(t[1],i[0])>0){i[0]=s(i[0],t[0]),i[1]=o(i[1],t[1]);break}}return r===i&&e.push(t),e},[]),c.sort(h)}catch(g){return zt(this,bt)}let f=0;const d=l?e=>r(e,c[f][1])>0:e=>r(e,c[f][1])>=0,m=a?e=>i(e,c[f][0])>0:e=>i(e,c[f][0])>=0;let p=d;const y=new this.Collection(this,()=>Zt(c[0][0],c[c.length-1][1],!a,!l));return y._ondirectionchange=e=>{"next"===e?(p=d,u=r):(p=m,u=i),c.sort(h)},y._addAlgorithm((e,t,n)=>{for(var i=e.key;p(i);)if(++f,f===c.length)return t(n),!1;return!!function(e){return!d(e)&&!m(e)}(i)||(0===this._cmp(i,c[f][1])||0===this._cmp(i,c[f][0])||t(()=>{e.continue(u===r?c[f][0]:c[f][1])}),!1)}),y}startsWithAnyOf(){const e=K.apply(N,arguments);return e.every(e=>"string"==typeof e)?0===e.length?Jt(this):this.inAnyRange(e.map(e=>[e,e+gt])):zt(this,"startsWithAnyOf() only works with strings")}}function nn(e){return Ge(function(t){return rn(t),e(t.target.error),!1})}function rn(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}const sn="storagemutated",on="x-storagemutated-1",an=Tt(null,sn);class ln{_lock(){return v(!Ce.global),++this._reculock,1!==this._reculock||Ce.global||(Ce.lockOwnerFor=this),this}_unlock(){if(v(!Ce.global),0==--this._reculock)for(Ce.global||(Ce.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{lt(e[1],e[0])}catch(t){}}return this}_locked(){return this._reculock&&Ce.lockOwnerFor!==this}create(e){if(!this.mode)return this;const t=this.db.idbdb,n=this.db._state.dbOpenError;if(v(!this.idbtrans),!e&&!t)switch(n&&n.name){case"DatabaseClosedError":throw new Z.DatabaseClosed(n);case"MissingAPIError":throw new Z.MissingAPI(n.message,n);default:throw new Z.OpenFailed(n)}if(!this.active)throw new Z.TransactionInactive;return v(null===this._completion._state),(e=this.idbtrans=e||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):t.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=Ge(t=>{rn(t),this._reject(e.error)}),e.onabort=Ge(t=>{rn(t),this.active&&this._reject(new Z.Abort(e.error)),this.active=!1,this.on("abort").fire(t)}),e.oncomplete=Ge(()=>{this.active=!1,this._resolve(),"mutatedParts"in e&&an.storagemutated.fire(e.mutatedParts)}),this}_promise(e,t,n){if("readwrite"===e&&"readwrite"!==this.mode)return mt(new Z.ReadOnly("Transaction is readonly"));if(!this.active)return mt(new Z.TransactionInactive);if(this._locked())return new Re((r,i)=>{this._blockedFuncs.push([()=>{this._promise(e,t,n).then(r,i)},Ce])});if(n)return et(()=>{var e=new Re((e,n)=>{this._lock();const r=t(e,n,this);r&&r.then&&r.then(e,n)});return e.finally(()=>this._unlock()),e._lib=!0,e});var r=new Re((e,n)=>{var r=t(e,n,this);r&&r.then&&r.then(e,n)});return r._lib=!0,r}_root(){return this.parent?this.parent._root():this}waitFor(e){var t=this._root();const n=Re.resolve(e);if(t._waitingFor)t._waitingFor=t._waitingFor.then(()=>n);else{t._waitingFor=n,t._waitingQueue=[];var r=t.idbtrans.objectStore(t.storeNames[0]);!function e(){for(++t._spinCount;t._waitingQueue.length;)t._waitingQueue.shift()();t._waitingFor&&(r.get(-1/0).onsuccess=e)}()}var i=t._waitingFor;return new Re((e,r)=>{n.then(n=>t._waitingQueue.push(Ge(e.bind(null,n))),e=>t._waitingQueue.push(Ge(r.bind(null,e)))).finally(()=>{t._waitingFor===i&&(t._waitingFor=null)})})}abort(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new Z.Abort))}table(e){const t=this._memoizedTables||(this._memoizedTables={});if(l(t,e))return t[e];const n=this.schema[e];if(!n)throw new Z.NotFound("Table "+e+" not part of transaction");const r=new this.db.Table(e,n,this);return r.core=this.db.core.table(e),t[e]=r,r}}function cn(e,t,n,r,i,s,o){return{name:e,keyPath:t,unique:n,multi:r,auto:i,compound:s,src:(n&&!o?"&":"")+(r?"*":"")+(i?"++":"")+un(t)}}function un(e){return"string"==typeof e?e:e?"["+[].join.call(e,"+")+"]":""}function hn(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:w(n,e=>[e.name,e])}}let fn=e=>{try{return e.only([[]]),fn=()=>[[]],[[]]}catch(t){return fn=()=>gt,gt}};function dn(e){return null==e?()=>{}:"string"==typeof e?function(e){return 1===e.split(".").length?t=>t[e]:t=>_(t,e)}(e):t=>_(t,e)}function mn(e){return[].slice.call(e)}let pn=0;function yn(e){return null==e?":id":"string"==typeof e?e:`[${e.join("+")}]`}function gn(e,t,n){function r(e){if(3===e.type)return null;if(4===e.type)throw new Error("Cannot convert never type to IDBKeyRange");const{lower:n,upper:r,lowerOpen:i,upperOpen:s}=e;return void 0===n?void 0===r?null:t.upperBound(r,!!s):void 0===r?t.lowerBound(n,!!i):t.bound(n,r,!!i,!!s)}const{schema:s,hasGetAll:o}=function(e,t){const n=mn(e.objectStoreNames);return{schema:{name:e.name,tables:n.map(e=>t.objectStore(e)).map(e=>{const{keyPath:t,autoIncrement:n}=e,r=i(t),s={},o={name:e.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:null==t,compound:r,keyPath:t,autoIncrement:n,unique:!0,extractKey:dn(t)},indexes:mn(e.indexNames).map(t=>e.index(t)).map(e=>{const{name:t,unique:n,multiEntry:r,keyPath:o}=e,a={name:t,compound:i(o),keyPath:o,unique:n,multiEntry:r,extractKey:dn(o)};return s[yn(o)]=a,a}),getIndexByKeyPath:e=>s[yn(e)]};return s[":id"]=o.primaryKey,null!=t&&(s[yn(t)]=o.primaryKey),o})},hasGetAll:n.length>0&&"getAll"in t.objectStore(n[0])&&!("undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}(e,n),a=s.tables.map(e=>function(e){const t=e.name;return{name:t,schema:e,mutate:function({trans:e,type:n,keys:i,values:s,range:o}){return new Promise((a,l)=>{a=Ge(a);const c=e.objectStore(t),u=null==c.keyPath,h="put"===n||"add"===n;if(!h&&"delete"!==n&&"deleteRange"!==n)throw new Error("Invalid operation type: "+n);const{length:f}=i||s||{length:1};if(i&&s&&i.length!==s.length)throw new Error("Given keys array must have same length as given values array.");if(0===f)return a({numFailures:0,failures:{},results:[],lastResult:void 0});let d;const m=[],p=[];let y=0;const g=e=>{++y,rn(e)};if("deleteRange"===n){if(4===o.type)return a({numFailures:y,failures:p,results:[],lastResult:void 0});m.push(d=3===o.type?c.clear():c.delete(r(o)))}else{const[e,t]=h?u?[s,i]:[s,null]:[i,null];if(h)for(let r=0;r<f;++r)m.push(d=t&&void 0!==t[r]?c[n](e[r],t[r]):c[n](e[r])),d.onerror=g;else for(let r=0;r<f;++r)m.push(d=c[n](e[r])),d.onerror=g}const v=e=>{const t=e.target.result;m.forEach((e,t)=>null!=e.error&&(p[t]=e.error)),a({numFailures:y,failures:p,results:"delete"===n?i:m.map(e=>e.result),lastResult:t})};d.onerror=e=>{g(e),v(e)},d.onsuccess=v})},getMany:({trans:e,keys:n})=>new Promise((r,i)=>{r=Ge(r);const s=e.objectStore(t),o=n.length,a=new Array(o);let l,c=0,u=0;const h=e=>{const t=e.target;a[t._pos]=t.result,++u===c&&r(a)},f=nn(i);for(let e=0;e<o;++e)null!=n[e]&&(l=s.get(n[e]),l._pos=e,l.onsuccess=h,l.onerror=f,++c);0===c&&r(a)}),get:({trans:e,key:n})=>new Promise((r,i)=>{r=Ge(r);const s=e.objectStore(t).get(n);s.onsuccess=e=>r(e.target.result),s.onerror=nn(i)}),query:function(e){return n=>new Promise((i,s)=>{i=Ge(i);const{trans:o,values:a,limit:l,query:c}=n,u=l===1/0?void 0:l,{index:h,range:f}=c,d=o.objectStore(t),m=h.isPrimaryKey?d:d.index(h.name),p=r(f);if(0===l)return i({result:[]});if(e){const e=a?m.getAll(p,u):m.getAllKeys(p,u);e.onsuccess=e=>i({result:e.target.result}),e.onerror=nn(s)}else{let e=0;const t=a||!("openKeyCursor"in m)?m.openCursor(p):m.openKeyCursor(p),n=[];t.onsuccess=r=>{const s=t.result;return s?(n.push(a?s.value:s.primaryKey),++e===l?i({result:n}):void s.continue()):i({result:n})},t.onerror=nn(s)}})}(o),openCursor:function({trans:e,values:n,query:i,reverse:s,unique:o}){return new Promise((a,l)=>{a=Ge(a);const{index:c,range:u}=i,h=e.objectStore(t),f=c.isPrimaryKey?h:h.index(c.name),d=s?o?"prevunique":"prev":o?"nextunique":"next",m=n||!("openKeyCursor"in f)?f.openCursor(r(u),d):f.openKeyCursor(r(u),d);m.onerror=nn(l),m.onsuccess=Ge(t=>{const n=m.result;if(!n)return void a(null);n.___id=++pn,n.done=!1;const r=n.continue.bind(n);let i=n.continuePrimaryKey;i&&(i=i.bind(n));const s=n.advance.bind(n),o=()=>{throw new Error("Cursor not stopped")};n.trans=e,n.stop=n.continue=n.continuePrimaryKey=n.advance=()=>{throw new Error("Cursor not started")},n.fail=Ge(l),n.next=function(){let e=1;return this.start(()=>e--?this.continue():this.stop()).then(()=>this)},n.start=e=>{const t=new Promise((e,t)=>{e=Ge(e),m.onerror=nn(t),n.fail=t,n.stop=t=>{n.stop=n.continue=n.continuePrimaryKey=n.advance=o,e(t)}}),a=()=>{if(m.result)try{e()}catch(t){n.fail(t)}else n.done=!0,n.start=()=>{throw new Error("Cursor behind last entry")},n.stop()};return m.onsuccess=Ge(e=>{m.onsuccess=a,a()}),n.continue=r,n.continuePrimaryKey=i,n.advance=s,a(),t},a(n)},l)})},count({query:e,trans:n}){const{index:i,range:s}=e;return new Promise((e,o)=>{const a=n.objectStore(t),l=i.isPrimaryKey?a:a.index(i.name),c=r(s),u=c?l.count(c):l.count();u.onsuccess=Ge(t=>e(t.target.result)),u.onerror=nn(o)})}}}(e)),l={};return a.forEach(e=>l[e.name]=e),{stack:"dbcore",transaction:e.transaction.bind(e),table(e){if(!l[e])throw new Error(`Table '${e}' not found`);return l[e]},MIN_KEY:-1/0,MAX_KEY:fn(t),schema:s}}function vn({_novip:e},t){const n=function(e,t,{IDBKeyRange:n},r){return{dbcore:function(e,t){return t.reduce((e,{create:t})=>({...e,...t(e)}),e)}(gn(t,n,r),e.dbcore)}}(e._middlewares,t.db,e._deps,t);e.core=n.dbcore,e.tables.forEach(t=>{const n=t.name;e.core.schema.tables.some(e=>e.name===n)&&(t.core=e.core.table(n),e[n]instanceof e.Table&&(e[n].core=t.core))})}function bn({_novip:e},t,n,r){n.forEach(n=>{const i=r[n];t.forEach(t=>{const r=m(t,n);(!r||"value"in r&&void 0===r.value)&&(t===e.Transaction.prototype||t instanceof e.Transaction?h(t,n,{get(){return this.table(n)},set(e){u(this,n,{value:e,writable:!0,configurable:!0,enumerable:!0})}}):t[n]=new e.Table(n,i))})})}function wn({_novip:e},t){t.forEach(t=>{for(let n in t)t[n]instanceof e.Table&&delete t[n]})}function _n(e,t){return e._cfg.version-t._cfg.version}function En(e,t){const n={del:[],add:[],change:[]};let r;for(r in e)t[r]||n.del.push(r);for(r in t){const i=e[r],s=t[r];if(i){const e={name:r,def:s,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(s.primKey.keyPath||"")||i.primKey.auto!==s.primKey.auto&&!Et)e.recreate=!0,n.change.push(e);else{const t=i.idxByName,r=s.idxByName;let o;for(o in t)r[o]||e.del.push(o);for(o in r){const n=t[o],i=r[o];n?n.src!==i.src&&e.change.push(i):e.add.push(i)}(e.del.length>0||e.add.length>0||e.change.length>0)&&n.change.push(e)}}else n.add.push([r,s])}return n}function Sn(e,t,n,r){const i=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(e=>kn(i,e)),i}function kn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function An(e,t,n){const r={};return y(t.objectStoreNames,0).forEach(e=>{const t=n.objectStore(e);let i=t.keyPath;const s=cn(un(i),i||"",!1,!1,!!t.autoIncrement,i&&"string"!=typeof i,!0),o=[];for(let n=0;n<t.indexNames.length;++n){const e=t.index(t.indexNames[n]);i=e.keyPath;var a=cn(e.name,i,!!e.unique,!!e.multiEntry,!1,i&&"string"!=typeof i,!1);o.push(a)}r[e]=hn(e,s,o)}),r}function On({_novip:e},t,r){const i=r.db.objectStoreNames;for(let n=0;n<i.length;++n){const s=i[n],o=r.objectStore(s);e._hasGetAll="getAll"in o;for(let e=0;e<o.indexNames.length;++e){const n=o.indexNames[e],r=o.index(n).keyPath,i="string"==typeof r?r:"["+y(r).join("+")+"]";if(t[s]){const e=t[s].idxByName[i];e&&(e.name=n,delete t[s].idxByName[i],t[s].idxByName[n]=e)}}}"undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&n.WorkerGlobalScope&&n instanceof n.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}class xn{_parseStoresSpec(e,t){r(e).forEach(n=>{if(null!==e[n]){var r=e[n].split(",").map((e,t)=>{const n=(e=e.trim()).replace(/([&*]|\+\+)/g,""),r=/^\[/.test(n)?n.match(/^\[(.*)\]$/)[1].split("+"):n;return cn(n,r||null,/\&/.test(e),/\*/.test(e),/\+\+/.test(e),i(r),0===t)}),s=r.shift();if(s.multi)throw new Z.Schema("Primary key cannot be multi-valued");r.forEach(e=>{if(e.auto)throw new Z.Schema("Only primary key can be marked as autoIncrement (++)");if(!e.keyPath)throw new Z.Schema("Index must have a name and cannot be an empty string")}),t[n]=hn(n,s,r)}})}stores(e){const t=this.db;this._cfg.storesSource=this._cfg.storesSource?s(this._cfg.storesSource,e):e;const n={};let i={};return t._versions.forEach(e=>{s(n,e._cfg.storesSource),i=e._cfg.dbschema={},e._parseStoresSpec(n,i)}),t._dbSchema=i,wn(t,[t._allTables,t,t.Transaction.prototype]),bn(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],r(i),i),t._storeNames=r(i),this}upgrade(e){return this._cfg.contentUpgrade=ue(this._cfg.contentUpgrade||ne,e),this}}function Cn(e,t){let n=e._dbNamesDB;return n||(n=e._dbNamesDB=new zn(Ot,{addons:[],indexedDB:e,IDBKeyRange:t}),n.version(1).stores({dbnames:"name"})),n.table("dbnames")}function Pn(e){return e&&"function"==typeof e.databases}function In(e){return et(function(){return Ce.letThrough=!0,e()})}function Mn(){var e;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(t){var n=function(){return indexedDB.databases().finally(t)};e=setInterval(n,100),n()}).finally(function(){return clearInterval(e)}):Promise.resolve()}function Rn(e){var t=t=>e.next(t),n=s(t),r=s(t=>e.throw(t));function s(e){return t=>{var s=e(t),o=s.value;return s.done?o:o&&"function"==typeof o.then?o.then(n,r):i(o)?Promise.all(o).then(n,r):n(o)}}return s(t)()}function Tn(e,t,n){var r=arguments.length;if(r<2)throw new Z.InvalidArgument("Too few arguments");for(var i=new Array(r-1);--r;)i[r-1]=arguments[r];n=i.pop();var s=A(i);return[e,s,n]}function Dn(e,t,n,r,i){return Re.resolve().then(()=>{const s=Ce.transless||Ce,o=e._createTransaction(t,n,e._dbSchema,r),a={trans:o,transless:s};r?o.idbtrans=r.idbtrans:o.create();const l=B(i);let c;l&&tt();const u=Re.follow(()=>{if(c=i.call(o,o),c)if(l){var e=nt.bind(null,null);c.then(e,e)}else"function"==typeof c.next&&"function"==typeof c.throw&&(c=Rn(c))},a);return(c&&"function"==typeof c.then?Re.resolve(c).then(e=>o.active?e:mt(new Z.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))):u.then(()=>c)).then(e=>(r&&o._resolve(),o._completion.then(()=>e))).catch(e=>(o._reject(e),mt(e)))})}function Nn(e,t,n){const r=i(e)?e.slice():[e];for(let i=0;i<n;++i)r.push(t);return r}const Kn={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return{...e,table(t){const n=e.table(t),{schema:r}=n,i={},s=[];function o(e,t,n){const r=yn(e),a=i[r]=i[r]||[],l=null==e?0:"string"==typeof e?1:e.length,c=t>0,u={...n,isVirtual:c,keyTail:t,keyLength:l,extractKey:dn(e),unique:!c&&n.unique};return a.push(u),u.isPrimaryKey||s.push(u),l>1&&o(2===l?e[0]:e.slice(0,l-1),t+1,n),a.sort((e,t)=>e.keyTail-t.keyTail),u}const a=o(r.primaryKey.keyPath,0,r.primaryKey);i[":id"]=[a];for(const e of r.indexes)o(e.keyPath,0,e);function l(t){const n=t.query.index;return n.isVirtual?{...t,query:{index:n,range:(r=t.query.range,i=n.keyTail,{type:1===r.type?2:r.type,lower:Nn(r.lower,r.lowerOpen?e.MAX_KEY:e.MIN_KEY,i),lowerOpen:!0,upper:Nn(r.upper,r.upperOpen?e.MIN_KEY:e.MAX_KEY,i),upperOpen:!0})}}:t;var r,i}return{...n,schema:{...r,primaryKey:a,indexes:s,getIndexByKeyPath:function(e){const t=i[yn(e)];return t&&t[0]}},count:e=>n.count(l(e)),query:e=>n.query(l(e)),openCursor(t){const{keyTail:r,isVirtual:i,keyLength:s}=t.query.index;return i?n.openCursor(l(t)).then(n=>n&&function(n){return Object.create(n,{continue:{value:function(i){null!=i?n.continue(Nn(i,t.reverse?e.MAX_KEY:e.MIN_KEY,r)):t.unique?n.continue(n.key.slice(0,s).concat(t.reverse?e.MIN_KEY:e.MAX_KEY,r)):n.continue()}},continuePrimaryKey:{value(t,i){n.continuePrimaryKey(Nn(t,e.MAX_KEY,r),i)}},primaryKey:{get:()=>n.primaryKey},key:{get(){const e=n.key;return 1===s?e[0]:e.slice(0,s)}},value:{get:()=>n.value}})}(n)):n.openCursor(t)}}}}}};function Bn(e,t,n,i){return n=n||{},i=i||"",r(e).forEach(r=>{if(l(t,r)){var s=e[r],o=t[r];if("object"==typeof s&&"object"==typeof o&&s&&o){const e=R(s);e!==R(o)?n[i+r]=t[r]:"Object"===e?Bn(s,o,n,i+r+"."):s!==o&&(n[i+r]=t[r])}else s!==o&&(n[i+r]=t[r])}else n[i+r]=void 0}),r(t).forEach(r=>{l(e,r)||(n[i+r]=t[r])}),n}const jn={stack:"dbcore",name:"HooksMiddleware",level:2,create:e=>({...e,table(t){const n=e.table(t),{primaryKey:r}=n.schema;return{...n,mutate(e){const i=Ce.trans,{deleting:s,creating:o,updating:a}=i.table(t).hook;switch(e.type){case"add":if(o.fire===ne)break;return i._promise("readwrite",()=>c(e),!0);case"put":if(o.fire===ne&&a.fire===ne)break;return i._promise("readwrite",()=>c(e),!0);case"delete":if(s.fire===ne)break;return i._promise("readwrite",()=>c(e),!0);case"deleteRange":if(s.fire===ne)break;return i._promise("readwrite",()=>function(e){return u(e.trans,e.range,1e4)}(e),!0)}return n.mutate(e);function c(e){const t=Ce.trans,i=e.keys||function(e,t){return"delete"===t.type?t.keys:t.keys||t.values.map(e.extractKey)}(r,e);if(!i)throw new Error("Keys missing");return"delete"!==(e="add"===e.type||"put"===e.type?{...e,keys:i}:{...e}).type&&(e.values=[...e.values]),e.keys&&(e.keys=[...e.keys]),function(e,t,n){return"add"===t.type?Promise.resolve([]):e.getMany({trans:t.trans,keys:n,cache:"immutable"})}(n,e,i).then(c=>{const u=i.map((n,i)=>{const u=c[i],h={onerror:null,onsuccess:null};if("delete"===e.type)s.fire.call(h,n,u,t);else if("add"===e.type||void 0===u){const s=o.fire.call(h,n,e.values[i],t);null==n&&null!=s&&(e.keys[i]=n=s,r.outbound||E(e.values[i],r.keyPath,n))}else{const r=Bn(u,e.values[i]),s=a.fire.call(h,r,n,u,t);if(s){const t=e.values[i];Object.keys(s).forEach(e=>{l(t,e)?t[e]=s[e]:E(t,e,s[e])})}}return h});return n.mutate(e).then(({failures:t,results:n,numFailures:r,lastResult:s})=>{for(let o=0;o<i.length;++o){const r=n?n[o]:i[o],s=u[o];null==r?s.onerror&&s.onerror(t[o]):s.onsuccess&&s.onsuccess("put"===e.type&&c[o]?e.values[o]:r)}return{failures:t,results:n,numFailures:r,lastResult:s}}).catch(e=>(u.forEach(t=>t.onerror&&t.onerror(e)),Promise.reject(e)))})}function u(e,t,i){return n.query({trans:e,values:!1,query:{index:r,range:t},limit:i}).then(({result:n})=>c({type:"delete",keys:n,trans:e}).then(r=>r.numFailures>0?Promise.reject(r.failures[0]):n.length<i?{failures:[],numFailures:0,lastResult:void 0}:u(e,{...t,lower:n[n.length-1],lowerOpen:!0},i)))}}}}})};function Ln(e,t,n){try{if(!t)return null;if(t.keys.length<e.length)return null;const r=[];for(let i=0,s=0;i<t.keys.length&&s<e.length;++i)0===Wt(t.keys[i],e[s])&&(r.push(n?P(t.values[i]):t.values[i]),++s);return r.length===e.length?r:null}catch(r){return null}}const qn={stack:"dbcore",level:-1,create:e=>({table:t=>{const n=e.table(t);return{...n,getMany:e=>{if(!e.cache)return n.getMany(e);const t=Ln(e.keys,e.trans._cache,"clone"===e.cache);return t?Re.resolve(t):n.getMany(e).then(t=>(e.trans._cache={keys:e.keys,values:"clone"===e.cache?P(t):t},t))},mutate:e=>("add"!==e.type&&(e.trans._cache=null),n.mutate(e))}}})};function Fn(e){return!("from"in e)}const Wn=function(e,t){if(!this){const t=new Wn;return e&&"d"in e&&s(t,e),t}s(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0})};function Vn(e,t,n){const r=Wt(t,n);if(isNaN(r))return;if(r>0)throw RangeError();if(Fn(e))return s(e,{from:t,to:n,d:1});const i=e.l,o=e.r;if(Wt(n,e.from)<0)return i?Vn(i,t,n):e.l={from:t,to:n,d:1,l:null,r:null},$n(e);if(Wt(t,e.to)>0)return o?Vn(o,t,n):e.r={from:t,to:n,d:1,l:null,r:null},$n(e);Wt(t,e.from)<0&&(e.from=t,e.l=null,e.d=o?o.d+1:1),Wt(n,e.to)>0&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1);const a=!e.r;i&&!e.l&&Hn(e,i),o&&a&&Hn(e,o)}function Hn(e,t){Fn(t)||function e(t,{from:n,to:r,l:i,r:s}){Vn(t,n,r),i&&e(t,i),s&&e(t,s)}(e,t)}function Un(e){let t=Fn(e)?null:{s:0,n:e};return{next(e){const n=arguments.length>0;for(;t;)switch(t.s){case 0:if(t.s=1,n)for(;t.n.l&&Wt(e,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!n||Wt(e,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function $n(e){var t,n;const r=((null===(t=e.r)||void 0===t?void 0:t.d)||0)-((null===(n=e.l)||void 0===n?void 0:n.d)||0),i=r>1?"r":r<-1?"l":"";if(i){const t="r"===i?"l":"r",n={...e},r=e[i];e.from=r.from,e.to=r.to,e[i]=r[i],n[i]=r[t],e[t]=n,n.d=Gn(n)}e.d=Gn(e)}function Gn({r:e,l:t}){return(e?t?Math.max(e.d,t.d):e.d:t?t.d:0)+1}c(Wn.prototype,{add(e){return Hn(this,e),this},addKey(e){return Vn(this,e,e),this},addKeys(e){return e.forEach(e=>Vn(this,e,e)),this},[T](){return Un(this)}});const Yn={stack:"dbcore",level:0,create:e=>{const t=e.schema.name,n=new Wn(e.MIN_KEY,e.MAX_KEY);return{...e,table:s=>{const o=e.table(s),{schema:a}=o,{primaryKey:l}=a,{extractKey:c,outbound:u}=l,h={...o,mutate:e=>{const r=e.trans,l=r.mutatedParts||(r.mutatedParts={}),c=e=>{const n=`idb://${t}/${s}/${e}`;return l[n]||(l[n]=new Wn)},u=c(""),h=c(":dels"),{type:f}=e;let[d,m]="deleteRange"===e.type?[e.range]:"delete"===e.type?[e.keys]:e.values.length<50?[[],e.values]:[];const p=e.trans._cache;return o.mutate(e).then(e=>{if(i(d)){"delete"!==f&&(d=e.results),u.addKeys(d);const t=Ln(d,p);t||"add"===f||h.addKeys(d),(t||m)&&function(e,t,n,r){t.indexes.forEach(function(t){const s=e(t.name||"");function o(e){return null!=e?t.extractKey(e):null}const a=e=>t.multiEntry&&i(e)?e.forEach(e=>s.addKey(e)):s.addKey(e);(n||r).forEach((e,t)=>{const i=n&&o(n[t]),s=r&&o(r[t]);0!==Wt(i,s)&&(null!=i&&a(i),null!=s&&a(s))})})}(c,a,t,m)}else if(d){const e={from:d.lower,to:d.upper};h.add(e),u.add(e)}else u.add(n),h.add(n),a.indexes.forEach(e=>c(e.name).add(n));return e})}},f=({query:{index:t,range:n}})=>{var r,i;return[t,new Wn(null!==(r=n.lower)&&void 0!==r?r:e.MIN_KEY,null!==(i=n.upper)&&void 0!==i?i:e.MAX_KEY)]},d={get:e=>[l,new Wn(e.key)],getMany:e=>[l,(new Wn).addKeys(e.keys)],count:f,query:f,openCursor:f};return r(d).forEach(e=>{h[e]=function(r){const{subscr:i}=Ce;if(i){const a=e=>{const n=`idb://${t}/${s}/${e}`;return i[n]||(i[n]=new Wn)},l=a(""),h=a(":dels"),[f,m]=d[e](r);if(a(f.name||"").add(m),!f.isPrimaryKey){if("count"!==e){const t="query"===e&&u&&r.values&&o.query({...r,values:!1});return o[e].apply(this,arguments).then(n=>{if("query"===e){if(u&&r.values)return t.then(({result:e})=>(l.addKeys(e),n));const e=r.values?n.result.map(c):n.result;r.values?l.addKeys(e):h.addKeys(e)}else if("openCursor"===e){const e=n,t=r.values;return e&&Object.create(e,{key:{get:()=>(h.addKey(e.primaryKey),e.key)},primaryKey:{get(){const t=e.primaryKey;return h.addKey(t),t}},value:{get:()=>(t&&l.addKey(e.primaryKey),e.value)}})}return n})}h.add(n)}}return o[e].apply(this,arguments)}}),h}}}};class zn{constructor(e,t){this._middlewares={},this.verno=0;const n=zn.dependencies;this._options=t={addons:zn.addons,autoOpen:!0,indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange,...t},this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange};const{addons:r}=t;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;const i={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:ne,dbReadyPromise:null,cancelOpen:ne,openCanceller:null,autoSchema:!0};i.dbReadyPromise=new Re(e=>{i.dbReadyResolve=e}),i.openCanceller=new Re((e,t)=>{i.cancelOpen=t}),this._state=i,this.name=e,this.on=Tt(this,"populate","blocked","versionchange","close",{ready:[ue,ne]}),this.on.ready.subscribe=g(this.on.ready.subscribe,e=>(t,n)=>{zn.vip(()=>{const r=this._state;if(r.openComplete)r.dbOpenError||Re.resolve().then(t),n&&e(t);else if(r.onReadyBeingFired)r.onReadyBeingFired.push(t),n&&e(t);else{e(t);const r=this;n||e(function e(){r.on.ready.unsubscribe(t),r.on.ready.unsubscribe(e)})}})}),this.Collection=function(e){return Dt(Ut.prototype,function(t,n){this.db=e;let r=It,i=null;if(n)try{r=n()}catch(l){i=l}const s=t._ctx,o=s.table,a=o.hook.reading.fire;this._ctx={table:o,index:s.index,isPrimKey:!s.index||o.schema.primKey.keyPath&&s.index===o.schema.primKey.name,range:r,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:i,or:s.or,valueMapper:a!==re?a:null}})}(this),this.Table=function(e){return Dt(Rt.prototype,function(t,n,r){this.db=e,this._tx=r,this.name=t,this.schema=n,this.hook=e._allTables[t]?e._allTables[t].hook:Tt(null,{creating:[oe,ne],reading:[ie,re],updating:[le,ne],deleting:[ae,ne]})})}(this),this.Transaction=function(e){return Dt(ln.prototype,function(t,n,r,i,s){this.db=e,this.mode=t,this.storeNames=n,this.schema=r,this.chromeTransactionDurability=i,this.idbtrans=null,this.on=Tt(this,"complete","error","abort"),this.parent=s||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Re((e,t)=>{this._resolve=e,this._reject=t}),this._completion.then(()=>{this.active=!1,this.on.complete.fire()},e=>{var t=this.active;return this.active=!1,this.on.error.fire(e),this.parent?this.parent._reject(e):t&&this.idbtrans&&this.idbtrans.abort(),mt(e)})})}(this),this.Version=function(e){return Dt(xn.prototype,function(t){this.db=e,this._cfg={version:t,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}(this),this.WhereClause=function(e){return Dt(tn.prototype,function(t,n,r){this.db=e,this._ctx={table:t,index:":id"===n?null:n,or:r};const i=e._deps.indexedDB;if(!i)throw new Z.MissingAPI;this._cmp=this._ascending=i.cmp.bind(i),this._descending=(e,t)=>i.cmp(t,e),this._max=(e,t)=>i.cmp(e,t)>0?e:t,this._min=(e,t)=>i.cmp(e,t)<0?e:t,this._IDBKeyRange=e._deps.IDBKeyRange})}(this),this.on("versionchange",e=>{e.newVersion>0?console.warn(`Another connection wants to upgrade database '${this.name}'. Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.name}'. Closing db now to resume the delete request.`),this.close()}),this.on("blocked",e=>{!e.newVersion||e.newVersion<e.oldVersion?console.warn(`Dexie.delete('${this.name}') was blocked`):console.warn(`Upgrade '${this.name}' blocked by other connection holding version ${e.oldVersion/10}`)}),this._maxKey=fn(t.IDBKeyRange),this._createTransaction=(e,t,n,r)=>new this.Transaction(e,t,n,this._options.chromeTransactionDurability,r),this._fireOnBlocked=e=>{this.on("blocked").fire(e),_t.filter(e=>e.name===this.name&&e!==this&&!e._state.vcFired).map(t=>t.on("versionchange").fire(e))},this.use(Kn),this.use(jn),this.use(Yn),this.use(qn),this.vip=Object.create(this,{_vip:{value:!0}}),r.forEach(e=>e(this))}version(e){if(isNaN(e)||e<.1)throw new Z.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new Z.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);const t=this._versions;var n=t.filter(t=>t._cfg.version===e)[0];return n||(n=new this.Version(e),t.push(n),t.sort(_n),n.stores({}),this._state.autoSchema=!1,n)}_whenReady(e){return this.idbdb&&(this._state.openComplete||Ce.letThrough||this._vip)?e():new Re((e,t)=>{if(this._state.openComplete)return t(new Z.DatabaseClosed(this._state.dbOpenError));if(!this._state.isBeingOpened){if(!this._options.autoOpen)return void t(new Z.DatabaseClosed);this.open().catch(ne)}this._state.dbReadyPromise.then(e,t)}).then(e)}use({stack:e,create:t,level:n,name:r}){r&&this.unuse({stack:e,name:r});const i=this._middlewares[e]||(this._middlewares[e]=[]);return i.push({stack:e,create:t,level:null==n?10:n,name:r}),i.sort((e,t)=>e.level-t.level),this}unuse({stack:e,name:t,create:n}){return e&&this._middlewares[e]&&(this._middlewares[e]=this._middlewares[e].filter(e=>n?e.create!==n:!!t&&e.name!==t)),this}open(){return function(e){const t=e._state,{indexedDB:n}=e._deps;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(()=>t.dbOpenError?mt(t.dbOpenError):e);j&&(t.openCanceller._stackHolder=W()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;const i=t.openCanceller;function s(){if(t.openCanceller!==i)throw new Z.DatabaseClosed("db.open() was cancelled")}let o=t.dbReadyResolve,a=null,l=!1;return Re.race([i,("undefined"==typeof navigator?Re.resolve():Mn()).then(()=>new Re((i,o)=>{if(s(),!n)throw new Z.MissingAPI;const c=e.name,u=t.autoSchema?n.open(c):n.open(c,Math.round(10*e.verno));if(!u)throw new Z.MissingAPI;u.onerror=nn(o),u.onblocked=Ge(e._fireOnBlocked),u.onupgradeneeded=Ge(i=>{if(a=u.transaction,t.autoSchema&&!e._options.allowEmptyDB){u.onerror=rn,a.abort(),u.result.close();const e=n.deleteDatabase(c);e.onsuccess=e.onerror=Ge(()=>{o(new Z.NoSuchDatabase(`Database ${c} doesnt exist`))})}else{a.onerror=nn(o);var s=i.oldVersion>Math.pow(2,62)?0:i.oldVersion;l=s<1,e._novip.idbdb=u.result,function(e,t,n,i){const s=e._dbSchema,o=e._createTransaction("readwrite",e._storeNames,s);o.create(n),o._completion.catch(i);const a=o._reject.bind(o),l=Ce.transless||Ce;et(()=>{Ce.trans=o,Ce.transless=l,0===t?(r(s).forEach(e=>{Sn(n,e,s[e].primKey,s[e].indexes)}),vn(e,n),Re.follow(()=>e.on.populate.fire(o)).catch(a)):function({_novip:e},t,n,i){const s=[],o=e._versions;let a=e._dbSchema=An(0,e.idbdb,i),l=!1;return o.filter(e=>e._cfg.version>=t).forEach(o=>{s.push(()=>{const s=a,c=o._cfg.dbschema;On(e,s,i),On(e,c,i),a=e._dbSchema=c;const u=En(s,c);u.add.forEach(e=>{Sn(i,e[0],e[1].primKey,e[1].indexes)}),u.change.forEach(e=>{if(e.recreate)throw new Z.Upgrade("Not yet support for changing primary key");{const t=i.objectStore(e.name);e.add.forEach(e=>kn(t,e)),e.change.forEach(e=>{t.deleteIndex(e.name),kn(t,e)}),e.del.forEach(e=>t.deleteIndex(e))}});const h=o._cfg.contentUpgrade;if(h&&o._cfg.version>t){vn(e,i),n._memoizedTables={},l=!0;let t=S(c);u.del.forEach(e=>{t[e]=s[e]}),wn(e,[e.Transaction.prototype]),bn(e,[e.Transaction.prototype],r(t),t),n.schema=t;const o=B(h);let a;o&&tt();const f=Re.follow(()=>{if(a=h(n),a&&o){var e=nt.bind(null,null);a.then(e,e)}});return a&&"function"==typeof a.then?Re.resolve(a):f.then(()=>a)}}),s.push(t=>{l&&St||function(e,t){[].slice.call(t.db.objectStoreNames).forEach(n=>null==e[n]&&t.db.deleteObjectStore(n))}(o._cfg.dbschema,t),wn(e,[e.Transaction.prototype]),bn(e,[e.Transaction.prototype],e._storeNames,e._dbSchema),n.schema=e._dbSchema})}),function e(){return s.length?Re.resolve(s.shift()(n.idbtrans)).then(e):Re.resolve()}().then(()=>{var e,t;t=i,r(e=a).forEach(n=>{t.db.objectStoreNames.contains(n)||Sn(t,n,e[n].primKey,e[n].indexes)})})}(e,t,o,n).catch(a)})}(e,s/10,a,o)}},o),u.onsuccess=Ge(()=>{a=null;const n=e._novip.idbdb=u.result,s=y(n.objectStoreNames);if(s.length>0)try{const i=n.transaction(1===(o=s).length?o[0]:o,"readonly");t.autoSchema?function({_novip:e},t,n){e.verno=t.version/10;const i=e._dbSchema=An(0,t,n);e._storeNames=y(t.objectStoreNames,0),bn(e,[e._allTables],r(i),i)}(e,n,i):(On(e,e._dbSchema,i),function(e,t){const n=En(An(0,e.idbdb,t),e._dbSchema);return!(n.add.length||n.change.some(e=>e.add.length||e.change.length))}(e,i)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),vn(e,i)}catch(h){}var o;_t.push(e),n.onversionchange=Ge(n=>{t.vcFired=!0,e.on("versionchange").fire(n)}),n.onclose=Ge(t=>{e.on("close").fire(t)}),l&&function({indexedDB:e,IDBKeyRange:t},n){!Pn(e)&&n!==Ot&&Cn(e,t).put({name:n}).catch(ne)}(e._deps,c),i()},o)}))]).then(()=>(s(),t.onReadyBeingFired=[],Re.resolve(In(()=>e.on.ready.fire(e.vip))).then(function n(){if(t.onReadyBeingFired.length>0){let r=t.onReadyBeingFired.reduce(ue,ne);return t.onReadyBeingFired=[],Re.resolve(In(()=>r(e.vip))).then(n)}}))).finally(()=>{t.onReadyBeingFired=null,t.isBeingOpened=!1}).then(()=>e).catch(n=>{t.dbOpenError=n;try{a&&a.abort()}catch(r){}return i===t.openCanceller&&e._close(),mt(n)}).finally(()=>{t.openComplete=!0,o()})}(this)}_close(){const e=this._state,t=_t.indexOf(this);if(t>=0&&_t.splice(t,1),this.idbdb){try{this.idbdb.close()}catch(n){}this._novip.idbdb=null}e.dbReadyPromise=new Re(t=>{e.dbReadyResolve=t}),e.openCanceller=new Re((t,n)=>{e.cancelOpen=n})}close(){this._close();const e=this._state;this._options.autoOpen=!1,e.dbOpenError=new Z.DatabaseClosed,e.isBeingOpened&&e.cancelOpen(e.dbOpenError)}delete(){const e=arguments.length>0,t=this._state;return new Re((n,r)=>{const i=()=>{this.close();var e=this._deps.indexedDB.deleteDatabase(this.name);e.onsuccess=Ge(()=>{!function({indexedDB:e,IDBKeyRange:t},n){!Pn(e)&&n!==Ot&&Cn(e,t).delete(n).catch(ne)}(this._deps,this.name),n()}),e.onerror=nn(r),e.onblocked=this._fireOnBlocked};if(e)throw new Z.InvalidArgument("Arguments not allowed in db.delete()");t.isBeingOpened?t.dbReadyPromise.then(i):i()})}backendDB(){return this.idbdb}isOpen(){return null!==this.idbdb}hasBeenClosed(){const e=this._state.dbOpenError;return e&&"DatabaseClosed"===e.name}hasFailed(){return null!==this._state.dbOpenError}dynamicallyOpened(){return this._state.autoSchema}get tables(){return r(this._allTables).map(e=>this._allTables[e])}transaction(){const e=Tn.apply(this,arguments);return this._transaction.apply(this,e)}_transaction(e,t,n){let r=Ce.trans;r&&r.db===this&&-1===e.indexOf("!")||(r=null);const i=-1!==e.indexOf("?");let s,o;e=e.replace("!","").replace("?","");try{if(o=t.map(e=>{var t=e instanceof this.Table?e.name:e;if("string"!=typeof t)throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return t}),"r"==e||e===xt)s=xt;else{if("rw"!=e&&e!=Ct)throw new Z.InvalidArgument("Invalid transaction mode: "+e);s=Ct}if(r){if(r.mode===xt&&s===Ct){if(!i)throw new Z.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");r=null}r&&o.forEach(e=>{if(r&&-1===r.storeNames.indexOf(e)){if(!i)throw new Z.SubTransaction("Table "+e+" not included in parent transaction.");r=null}}),i&&r&&!r.active&&(r=null)}}catch(l){return r?r._promise(null,(e,t)=>{t(l)}):mt(l)}const a=Dn.bind(null,this,s,o,r,n);return r?r._promise(s,a,"lock"):Ce.trans?lt(Ce.transless,()=>this._whenReady(a)):this._whenReady(a)}table(e){if(!l(this._allTables,e))throw new Z.InvalidTable(`Table ${e} does not exist`);return this._allTables[e]}}const Jn="undefined"!=typeof Symbol&&"observable"in Symbol?Symbol.observable:"@@observable";class Qn{constructor(e){this._subscribe=e}subscribe(e,t,n){return this._subscribe(e&&"function"!=typeof e?e:{next:e,error:t,complete:n})}[Jn](){return this}}function Xn(e,t){return r(t).forEach(n=>{Hn(e[n]||(e[n]=new Wn),t[n])}),e}let Zn;try{Zn={indexedDB:n.indexedDB||n.mozIndexedDB||n.webkitIndexedDB||n.msIndexedDB,IDBKeyRange:n.IDBKeyRange||n.webkitIDBKeyRange}}catch(Er){Zn={indexedDB:null,IDBKeyRange:null}}const er=zn;function tr(e){let t=nr;try{nr=!0,an.storagemutated.fire(e)}finally{nr=t}}c(er,{...te,delete:e=>new er(e,{addons:[]}).delete(),exists:e=>new er(e,{addons:[]}).open().then(e=>(e.close(),!0)).catch("NoSuchDatabaseError",()=>!1),getDatabaseNames(e){try{return function({indexedDB:e,IDBKeyRange:t}){return Pn(e)?Promise.resolve(e.databases()).then(e=>e.map(e=>e.name).filter(e=>e!==Ot)):Cn(e,t).toCollection().primaryKeys()}(er.dependencies).then(e)}catch(t){return mt(new Z.MissingAPI)}},defineClass:()=>function(e){s(this,e)},ignoreTransaction:e=>Ce.trans?lt(Ce.transless,e):e(),vip:In,async:function(e){return function(){try{var t=Rn(e.apply(this,arguments));return t&&"function"==typeof t.then?t:Re.resolve(t)}catch(Er){return mt(Er)}}},spawn:function(e,t,n){try{var r=Rn(e.apply(n,t||[]));return r&&"function"==typeof r.then?r:Re.resolve(r)}catch(Er){return mt(Er)}},currentTransaction:{get:()=>Ce.trans||null},waitFor:function(e,t){const n=Re.resolve("function"==typeof e?er.ignoreTransaction(e):e).timeout(t||6e4);return Ce.trans?Ce.trans.waitFor(n):n},Promise:Re,debug:{get:()=>j,set:e=>{L(e,"dexie"===e?()=>!0:At)}},derive:f,extend:s,props:c,override:g,Events:Tt,on:an,liveQuery:function(e){return new Qn(t=>{const n=B(e);let i=!1,s={},o={};const a={get closed(){return i},unsubscribe:()=>{i=!0,an.storagemutated.unsubscribe(h)}};t.start&&t.start(a);let l=!1,c=!1;function u(){return r(o).some(e=>s[e]&&function(e,t){const n=Un(t);let r=n.next();if(r.done)return!1;let i=r.value;const s=Un(e);let o=s.next(i.from),a=o.value;for(;!r.done&&!o.done;){if(Wt(a.from,i.to)<=0&&Wt(a.to,i.from)>=0)return!0;Wt(i.from,a.from)<0?i=(r=n.next(a.from)).value:a=(o=s.next(i.from)).value}return!1}(s[e],o[e]))}const h=e=>{Xn(s,e),u()&&f()},f=()=>{if(l||i)return;s={};const r={},d=function(t){n&&tt();const r=()=>et(e,{subscr:t,trans:null}),i=Ce.trans?lt(Ce.transless,r):r();return n&&i.then(nt,nt),i}(r);c||(an(sn,h),c=!0),l=!0,Promise.resolve(d).then(e=>{l=!1,i||(u()?f():(s={},o=r,t.next&&t.next(e)))},e=>{l=!1,t.error&&t.error(e),a.unsubscribe()})};return f(),a})},extendObservabilitySet:Xn,getByKeyPath:_,setByKeyPath:E,delByKeyPath:function(e,t){"string"==typeof t?E(e,t,void 0):"length"in t&&[].map.call(t,function(t){E(e,t,void 0)})},shallowClone:S,deepClone:P,getObjectDiff:Bn,cmp:Wt,asap:b,minKey:vt,addons:[],connections:_t,errnames:Q,dependencies:Zn,semVer:yt,version:yt.split(".").map(e=>parseInt(e)).reduce((e,t,n)=>e+t/Math.pow(10,2*n))}),er.maxKey=fn(er.dependencies.IDBKeyRange),"undefined"!=typeof dispatchEvent&&"undefined"!=typeof addEventListener&&(an(sn,e=>{if(!nr){let t;Et?(t=document.createEvent("CustomEvent"),t.initCustomEvent(on,!0,!0,e)):t=new CustomEvent(on,{detail:e}),nr=!0,dispatchEvent(t),nr=!1}}),addEventListener(on,({detail:e})=>{nr||tr(e)}));let nr=!1;if("undefined"!=typeof BroadcastChannel){const e=new BroadcastChannel(on);an(sn,t=>{nr||e.postMessage(t)}),e.onmessage=e=>{e.data&&tr(e.data)}}else if("undefined"!=typeof self&&"undefined"!=typeof navigator){an(sn,e=>{try{nr||("undefined"!=typeof localStorage&&localStorage.setItem(on,JSON.stringify({trig:Math.random(),changedParts:e})),"object"==typeof self.clients&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach(t=>t.postMessage({type:on,changedParts:e})))}catch(t){}}),addEventListener("storage",e=>{if(e.key===on){const t=JSON.parse(e.newValue);t&&tr(t.changedParts)}});const e=self.document&&navigator.serviceWorker;e&&e.addEventListener("message",function({data:e}){e&&e.type===on&&tr(e.changedParts)})}Re.rejectionMapper=function(e,t){if(!e||e instanceof G||e instanceof TypeError||e instanceof SyntaxError||!e.name||!ee[e.name])return e;var n=new ee[e.name](t||e.message,e);return"stack"in e&&h(n,"stack",{get:function(){return this.inner.stack}}),n},L(j,At);var rr=(()=>(function(e){e[e.ArmorSlotNone=0]="ArmorSlotNone",e[e.ArmorSlotHelmet=1]="ArmorSlotHelmet",e[e.ArmorSlotGauntlet=2]="ArmorSlotGauntlet",e[e.ArmorSlotChest=3]="ArmorSlotChest",e[e.ArmorSlotLegs=4]="ArmorSlotLegs",e[e.ArmorSlotClass=5]="ArmorSlotClass"}(rr||(rr={})),rr))(),ir=(()=>(function(e){e[e.PowerfulFriends=0]="PowerfulFriends",e[e.RadiantLight=1]="RadiantLight",e[e.ProtectiveLight=100]="ProtectiveLight",e[e.ExtraReserves=101]="ExtraReserves",e[e.PreciselyCharged=102]="PreciselyCharged",e[e.StacksOnStacks=103]="StacksOnStacks",e[e.PrecisionCharge=104]="PrecisionCharge",e[e.SurpriseAttack=105]="SurpriseAttack",e[e.EnergyConverter=106]="EnergyConverter",e[e.ChargeHarvester=107]="ChargeHarvester",e[e.WhisperOfDurance=1e3]="WhisperOfDurance",e[e.WhisperOfChains=1001]="WhisperOfChains",e[e.WhisperOfConduction=1002]="WhisperOfConduction",e[e.WhisperOfShards=1003]="WhisperOfShards",e[e.WhisperOfHedrons=1100]="WhisperOfHedrons",e[e.WhisperOfBonds=1101]="WhisperOfBonds",e[e.WhisperOfHunger=1102]="WhisperOfHunger",e[e.WhisperOfFractures=1103]="WhisperOfFractures",e[e.EchoOfExpulsion=1200]="EchoOfExpulsion",e[e.EchoOfProvision=1201]="EchoOfProvision",e[e.EchoOfPersistence=1202]="EchoOfPersistence",e[e.EchoOfLeeching=1203]="EchoOfLeeching",e[e.EchoOfDomineering=1204]="EchoOfDomineering",e[e.EchoOfDilation=1205]="EchoOfDilation",e[e.EchoOfUndermining=1206]="EchoOfUndermining",e[e.EchoOfInstability=1207]="EchoOfInstability",e[e.EchoOfHarvest=1208]="EchoOfHarvest",e[e.EchoOfObscurity=1209]="EchoOfObscurity",e[e.EchoOfStarvation=1210]="EchoOfStarvation",e[e.EmberOfBenelovence=1300]="EmberOfBenelovence",e[e.EmberOfBeams=1301]="EmberOfBeams",e[e.EmberOfEmpyrean=1302]="EmberOfEmpyrean",e[e.EmberOfCombustion=1303]="EmberOfCombustion",e[e.EmberOfChar=1304]="EmberOfChar",e[e.EmberOfTempering=1305]="EmberOfTempering",e[e.EmberOfEruption=1306]="EmberOfEruption",e[e.EmberOfWonder=1307]="EmberOfWonder",e[e.EmberOfSearing=1308]="EmberOfSearing"}(ir||(ir={})),ir))(),sr=(()=>(function(e){e[e.CombatStyleMod=0]="CombatStyleMod",e[e.Stasis=1]="Stasis",e[e.Void=2]="Void",e[e.Solar=3]="Solar"}(sr||(sr={})),sr))(),or=(()=>(function(e){e[e.NONE=0]="NONE",e[e.MINOR_MOBILITY=1]="MINOR_MOBILITY",e[e.MAJOR_MOBILITY=2]="MAJOR_MOBILITY",e[e.MINOR_RESILIENCE=3]="MINOR_RESILIENCE",e[e.MAJOR_RESILIENCE=4]="MAJOR_RESILIENCE",e[e.MINOR_RECOVERY=5]="MINOR_RECOVERY",e[e.MAJOR_RECOVERY=6]="MAJOR_RECOVERY",e[e.MINOR_DISCIPLINE=7]="MINOR_DISCIPLINE",e[e.MAJOR_DISCIPLINE=8]="MAJOR_DISCIPLINE",e[e.MINOR_INTELLECT=9]="MINOR_INTELLECT",e[e.MAJOR_INTELLECT=10]="MAJOR_INTELLECT",e[e.MINOR_STRENGTH=11]="MINOR_STRENGTH",e[e.MAJOR_STRENGTH=12]="MAJOR_STRENGTH"}(or||(or={})),or))(),ar=(()=>(function(e){e[e.Mobility=0]="Mobility",e[e.Resilience=1]="Resilience",e[e.Recovery=2]="Recovery",e[e.Discipline=3]="Discipline",e[e.Intellect=4]="Intellect",e[e.Strength=5]="Strength"}(ar||(ar={})),ar))();const lr={[or.NONE]:[ar.Strength,0,0,0],[or.MINOR_MOBILITY]:[ar.Mobility,5,1,204137529],[or.MAJOR_MOBILITY]:[ar.Mobility,10,3,3961599962],[or.MINOR_RESILIENCE]:[ar.Resilience,5,1,3682186345],[or.MAJOR_RESILIENCE]:[ar.Resilience,10,3,2850583378],[or.MINOR_RECOVERY]:[ar.Recovery,5,2,555005975],[or.MAJOR_RECOVERY]:[ar.Recovery,10,4,2645858828],[or.MINOR_DISCIPLINE]:[ar.Discipline,5,1,2623485440],[or.MAJOR_DISCIPLINE]:[ar.Discipline,10,3,4048838440],[or.MINOR_INTELLECT]:[ar.Intellect,5,2,1227870362],[or.MAJOR_INTELLECT]:[ar.Intellect,10,5,3355995799],[or.MINOR_STRENGTH]:[ar.Strength,5,1,3699676109],[or.MAJOR_STRENGTH]:[ar.Strength,10,3,3253038666]};var cr=(()=>(function(e){e[e.ClassAbilityRegenerationStat=10]="ClassAbilityRegenerationStat"}(cr||(cr={})),cr))(),ur=(()=>(function(e){e[e.None=0]="None",e[e.SlotNightmare=1]="SlotNightmare",e[e.SlotArtificer=2]="SlotArtificer",e[e.SlotLastWish=3]="SlotLastWish",e[e.SlotGardenOfSalvation=4]="SlotGardenOfSalvation",e[e.SlotDeepStoneCrypt=5]="SlotDeepStoneCrypt",e[e.SlotVaultOfGlass=6]="SlotVaultOfGlass",e[e.PerkIronBanner=7]="PerkIronBanner",e[e.PerkUniformedOfficer=8]="PerkUniformedOfficer",e[e.SlotVowOfTheDisciple=9]="SlotVowOfTheDisciple",e[e.COUNT=10]="COUNT"}(ur||(ur={})),ur))();const hr={[ir.PowerfulFriends]:{id:ir.PowerfulFriends,name:"Powerful Friends",description:"When you become Charged with Light, nearby allies also become Charged with Light, if they are not already.",type:sr.CombatStyleMod,bonus:[{stat:ar.Mobility,value:20}],cost:4,requiredArmorAffinity:1,hash:1484685887},[ir.RadiantLight]:{id:ir.RadiantLight,name:"Radiant Light",description:"Casting your Super causes nearby allies to become Charged with Light.",type:sr.CombatStyleMod,bonus:[{stat:ar.Strength,value:20}],cost:3,requiredArmorAffinity:1,hash:2979815167},[ir.ProtectiveLight]:{id:ir.ProtectiveLight,name:"Protective Light",description:"While Charged with Light, you gain significant damage resistance against combatants when your shields are destroyed. This effect consumes all stacks of Charged with Light. The more stacks consumed, the longer the damage resistance lasts.",type:sr.CombatStyleMod,bonus:[{stat:ar.Strength,value:-10}],cost:2,requiredArmorAffinity:3,hash:3523075120},[ir.ExtraReserves]:{id:ir.ExtraReserves,name:"Extra Reserves",description:"While Charged with Light, defeating combatants with Void damage grants a chance to drop Special ammo. This effect consumes all stacks of Charged with Light. The more stacks you have, the higher your chance of gaining the ammo drop.",type:sr.CombatStyleMod,bonus:[{stat:ar.Intellect,value:-10}],cost:3,requiredArmorAffinity:3,hash:3523075121},[ir.PreciselyCharged]:{id:ir.PreciselyCharged,name:"Precisely Charged",description:"Become Charged with Light by getting multiple rapid precision final blows with Linear Fusion Rifles or Sniper Rifles.",type:sr.CombatStyleMod,bonus:[{stat:ar.Discipline,value:-10}],cost:1,requiredArmorAffinity:3,hash:3523075122},[ir.StacksOnStacks]:{id:ir.StacksOnStacks,name:"Stacks on Stacks",description:"Gain an extra stack of Charged with Light for every stack you gain.",type:sr.CombatStyleMod,bonus:[{stat:ar.Recovery,value:-10}],cost:4,requiredArmorAffinity:3,hash:3523075123},[ir.PrecisionCharge]:{id:ir.PrecisionCharge,name:"Precision Charge",description:"Become Charged with Light by rapidly defeating combatants with precision kills from Bows, Hand Cannons, and Scout Rifles.",type:sr.CombatStyleMod,bonus:[{stat:ar.Strength,value:-10}],cost:2,requiredArmorAffinity:3,hash:2263321584},[ir.SurpriseAttack]:{id:ir.SurpriseAttack,name:"Surprise Attack",description:"While Charged with Light, reloading or readying a Sidearm will consume all stacks of Charged with Light and convert them into stacks of a major damage buff, which are depleted as you damage combatants with that Sidearm.",type:sr.CombatStyleMod,bonus:[{stat:ar.Intellect,value:-10}],cost:1,requiredArmorAffinity:3,hash:2263321585},[ir.EnergyConverter]:{id:ir.EnergyConverter,name:"Energy Converter",description:"While Charged with Light, using your grenade attack grants you Super energy, consuming all stacks of Charged with Light. The more stacks you have, the more energy you gain, up to a maximum of 50% of your Super energy.",type:sr.CombatStyleMod,bonus:[{stat:ar.Discipline,value:-10}],cost:4,requiredArmorAffinity:3,hash:2263321586},[ir.ChargeHarvester]:{id:ir.ChargeHarvester,name:"Charge Harvester",description:"While you are not Charged with Light, any kill or assist has a small cumulative chance to cause you to become Charged with Light.",type:sr.CombatStyleMod,bonus:[{stat:cr.ClassAbilityRegenerationStat,value:-10}],cost:3,requiredArmorAffinity:3,hash:2263321587},[ir.WhisperOfDurance]:{id:ir.WhisperOfDurance,name:"Whisper Of Durance",description:"Slow from your abilities lasts longer. For those abilities that linger, their duration will also increase.",type:sr.Stasis,bonus:[{stat:ar.Strength,value:10}],cost:1,requiredArmorAffinity:0,hash:3469412969},[ir.WhisperOfChains]:{id:ir.WhisperOfChains,name:"Whisper Of Chains",description:"While you are near frozen targets or a friendly Stasis crystal, you take reduced damage from targets.",type:sr.Stasis,bonus:[{stat:ar.Recovery,value:10}],cost:1,requiredArmorAffinity:0,hash:537774540},[ir.WhisperOfShards]:{id:ir.WhisperOfShards,name:"Whisper Of Shards",description:"Shattering a Stasis crystal temporarily boosts your grenade recharge rate. Shattering additional Stasis crystals increases the duration of this benefit.",type:sr.Stasis,bonus:[{stat:ar.Resilience,value:10}],cost:1,requiredArmorAffinity:0,hash:3469412975},[ir.WhisperOfConduction]:{id:ir.WhisperOfConduction,name:"Whisper Of Conduction",description:"Nearby Stasis shards track to your position.",type:sr.Stasis,bonus:[{stat:ar.Resilience,value:10},{stat:ar.Intellect,value:10}],cost:1,requiredArmorAffinity:0,hash:2483898429},[ir.WhisperOfBonds]:{id:ir.WhisperOfBonds,name:"Whisper of Bonds",description:"Defeating frozen targets grants you Super energy.",type:sr.Stasis,bonus:[{stat:ar.Discipline,value:-10},{stat:ar.Intellect,value:-10}],cost:1,requiredArmorAffinity:0,hash:3469412974},[ir.WhisperOfHedrons]:{id:ir.WhisperOfHedrons,name:"Whisper of Hedrons",description:"Dramatically increases weapon stability, weapon aim assist, Mobility, Resilience, and Recovery after freezing a target with Stasis.",type:sr.Stasis,bonus:[{stat:ar.Strength,value:-10}],cost:1,requiredArmorAffinity:0,hash:3469412970},[ir.WhisperOfFractures]:{id:ir.WhisperOfFractures,name:"Whisper of Fractures",description:"Your melee energy recharges faster when you are near two or more targets.",type:sr.Stasis,bonus:[{stat:ar.Discipline,value:-10}],cost:1,requiredArmorAffinity:0,hash:537774542},[ir.WhisperOfHunger]:{id:ir.WhisperOfHunger,name:"Whisper of Hunger",description:"Increases the melee energy gained from picking up Stasis shards.",type:sr.Stasis,bonus:[{stat:ar.Mobility,value:-10},{stat:ar.Recovery,value:-10}],cost:1,requiredArmorAffinity:0,hash:2483898431},[ir.EchoOfExpulsion]:{id:ir.EchoOfExpulsion,name:"Echo of Expulsion",description:"Void ability final blows cause targets to explode.",type:sr.Void,bonus:[{stat:ar.Intellect,value:10}],cost:1,requiredArmorAffinity:0,hash:2272984665},[ir.EchoOfProvision]:{id:ir.EchoOfProvision,name:"Echo of Provision",description:"Damaging targets with grenades grants melee energy.",type:sr.Void,bonus:[{stat:ar.Strength,value:-10}],cost:1,requiredArmorAffinity:0,hash:2272984664},[ir.EchoOfPersistence]:{id:ir.EchoOfPersistence,name:"Echo of Persistence",description:"Void buffs applied to you (Invisibility, Overshield, and Devour) have increased duration.",type:sr.Void,bonus:[{stat:cr.ClassAbilityRegenerationStat,value:-10}],cost:1,requiredArmorAffinity:0,hash:2272984671},[ir.EchoOfLeeching]:{id:ir.EchoOfLeeching,name:"Echo of Leeching",description:"Melee final blows start health regeneration for you and nearby allies.",type:sr.Void,bonus:[{stat:ar.Resilience,value:10}],cost:1,requiredArmorAffinity:0,hash:2272984670},[ir.EchoOfDomineering]:{id:ir.EchoOfDomineering,name:"Echo of Domineering",description:"After suppressing a target, you gain greatly increased Mobility for a short duration and your equipped weapon is reloaded from reserves.",type:sr.Void,bonus:[{stat:ar.Discipline,value:10}],cost:1,requiredArmorAffinity:0,hash:2272984657},[ir.EchoOfDilation]:{id:ir.EchoOfDilation,name:"Echo of Dilation",description:"While crouched, you sneak faster and gain enhanced radar resolution.",type:sr.Void,bonus:[{stat:ar.Mobility,value:10},{stat:ar.Intellect,value:10}],cost:1,requiredArmorAffinity:0,hash:2272984656},[ir.EchoOfUndermining]:{id:ir.EchoOfUndermining,name:"Echo of Undermining",description:"Your Void grenades weaken targets.",type:sr.Void,bonus:[{stat:ar.Discipline,value:-20}],cost:1,requiredArmorAffinity:0,hash:2272984668},[ir.EchoOfInstability]:{id:ir.EchoOfInstability,name:"Echo of Instability",description:"Defeating targets with grenades grants Volatile Rounds to your Void weapons.",type:sr.Void,bonus:[{stat:ar.Strength,value:10}],cost:1,requiredArmorAffinity:0,hash:2661180600},[ir.EchoOfObscurity]:{id:ir.EchoOfObscurity,name:"Echo of Obscurity",description:"Finisher final blows grant Invisibility.",type:sr.Void,bonus:[{stat:ar.Recovery,value:10}],cost:1,requiredArmorAffinity:0,hash:2661180602},[ir.EchoOfHarvest]:{id:ir.EchoOfHarvest,name:"Echo of Harvest",description:"Defeating weakened targets with precision final blows will create an Orb of Power.",type:sr.Void,bonus:[{stat:ar.Intellect,value:-10}],cost:1,requiredArmorAffinity:0,hash:2661180601},[ir.EchoOfStarvation]:{id:ir.EchoOfStarvation,name:"Echo of Starvation",description:"Picking up an Orb of Power grants Devour.",type:sr.Void,bonus:[{stat:ar.Recovery,value:-10}],cost:1,requiredArmorAffinity:0,hash:2661180603},[ir.EmberOfBenelovence]:{id:ir.EmberOfBenelovence,name:"Ember of Benelovence",description:"Applying restoration, cure, or radiant to allies grants increased grenade, melee, and class ability regeneration for a short duration.",type:sr.Solar,bonus:[{stat:ar.Discipline,value:-10}],cost:1,requiredArmorAffinity:0,hash:362132292},[ir.EmberOfBeams]:{id:ir.EmberOfBeams,name:"Ember of Beams",description:"Your Solar Super projectiles have stronger target acquisition.",type:sr.Solar,bonus:[{stat:ar.Intellect,value:10}],cost:1,requiredArmorAffinity:0,hash:362132295},[ir.EmberOfEmpyrean]:{id:ir.EmberOfEmpyrean,name:"Ember of Empyrean",description:"Solar weapon or ability final blows extend the duration of restoration and radiant effects applied to you.",type:sr.Solar,bonus:[{stat:ar.Resilience,value:-10}],cost:1,requiredArmorAffinity:0,hash:362132294},[ir.EmberOfCombustion]:{id:ir.EmberOfCombustion,name:"Ember of Combustion",description:"Final blows with your Solar Super cause targets to ignite.",type:sr.Solar,bonus:[{stat:ar.Strength,value:10}],cost:1,requiredArmorAffinity:0,hash:362132289},[ir.EmberOfChar]:{id:ir.EmberOfChar,name:"Ember of Char",description:"Your Solar ignitions spread scorch to affected targets.",type:sr.Solar,bonus:[{stat:ar.Discipline,value:10}],cost:1,requiredArmorAffinity:0,hash:362132291},[ir.EmberOfTempering]:{id:ir.EmberOfTempering,name:"Ember of Tempering",description:"Solar weapon final blows grant you and your allies increased recovery for a short duration. Stacks 3 times.\nWhile Ember of Tempering is active, your weapons have increased airborne effectiveness.",type:sr.Solar,bonus:[{stat:ar.Recovery,value:-10}],cost:1,requiredArmorAffinity:0,hash:362132290},[ir.EmberOfEruption]:{id:ir.EmberOfEruption,name:"Ember of Eruption",description:"Your Solar ignitions have increased area of effect.",type:sr.Solar,bonus:[{stat:ar.Strength,value:10}],cost:1,requiredArmorAffinity:0,hash:1051276348},[ir.EmberOfWonder]:{id:ir.EmberOfWonder,name:"Ember of Wonder",description:"Rapidly defeating multiple targets with Solar ignitions generates an Orb of Power.",type:sr.Solar,bonus:[{stat:ar.Resilience,value:10}],cost:1,requiredArmorAffinity:0,hash:1051276350},[ir.EmberOfSearing]:{id:ir.EmberOfSearing,name:"Ember of Searing",description:"Defeating scorched targets grants melee energy.",type:sr.Solar,bonus:[{stat:ar.Recovery,value:10}],cost:1,requiredArmorAffinity:0,hash:1051276351}};Array.prototype.addSorted=function(e){var t,n=0,r=this.length,i=!1;if(e>this[r])return this.push(e),this;if(e<this[n])return this.splice(n,0,e),this;for(;0==i;)e>this[t=~~((n+r)/2)]?n=t:r=t,r-n<=1&&(this.splice(r,0,e),i=!0);return this},Array.prototype.where=Array.prototype.where||function(e){for(var t=[],n=this.length,r=0;r<n;r++){var i=this[r];e(i)&&t.push(i)}return t};const fr=function(e){const n=new zn("d2armorpicker-v2");return n.version(16).stores({manifestArmor:"id++, hash, isExotic",inventoryArmor:"id++, itemInstanceId, isExotic, hash, name, masterworked, clazz"}).upgrade(function(){var n=t(function*(t){yield e()});return function(e){return n.apply(this,arguments)}}()),n}(t(function*(){})),dr=fr.table("inventoryArmor"),mr=fr.table("manifestArmor");class pr{constructor(e){this.items=[],this.mobility={min:0,max:0,sum:0},this.resilience={min:0,max:0,sum:0},this.recovery={min:0,max:0,sum:0},this.discipline={min:0,max:0,sum:0},this.intellect={min:0,max:0,sum:0},this.strength={min:0,max:0,sum:0},this.containsExotics=!1,this.containsLegendaries=!1,this.allMasterworked=!1,this.elements=[],this.perks=[],this.allSameElement=!0,this.items=e;const t=this.items.map(e=>e.mobility),n=this.items.map(e=>e.resilience),r=this.items.map(e=>e.recovery),i=this.items.map(e=>e.discipline),s=this.items.map(e=>e.intellect),o=this.items.map(e=>e.strength);this.mobility.min=Math.min(...t),this.mobility.sum=t.reduce((e,t)=>e+t,0),this.resilience.min=Math.min(...n),this.resilience.sum=n.reduce((e,t)=>e+t,0),this.recovery.min=Math.min(...r),this.recovery.sum=r.reduce((e,t)=>e+t,0),this.discipline.min=Math.min(...i),this.discipline.sum=i.reduce((e,t)=>e+t,0),this.intellect.min=Math.min(...s),this.intellect.sum=s.reduce((e,t)=>e+t,0),this.strength.min=Math.min(...o),this.strength.sum=o.reduce((e,t)=>e+t,0),this.containsExotics=this._containsExotics,this.containsLegendaries=this._containsLegendaries,this.allMasterworked=this._allMasterworked,this.elements=e.map(e=>e.energyAffinity),this.perks=e.map(e=>e.perk),this.allSameElement=1==new Set(e).size}get _containsExotics(){return this.items.filter(e=>e.isExotic).length>0}get _containsLegendaries(){return this.items.filter(e=>!e.isExotic).length>0}get _allMasterworked(){return this.items.filter(e=>e.masterworked).length==this.items.length}}function yr(e,t,n,r,i,s,o){let a=t.slice(),l=a[0];r.allMasterworked&&e.ignoreArmorAffinitiesOnMasterworkedItems||!r.allMasterworked&&e.ignoreArmorAffinitiesOnNonMasterworkedItems?l++:a[r.elements[0]]--,i.allMasterworked&&e.ignoreArmorAffinitiesOnMasterworkedItems||!i.allMasterworked&&e.ignoreArmorAffinitiesOnNonMasterworkedItems?l++:a[i.elements[0]]--,s.allMasterworked&&e.ignoreArmorAffinitiesOnMasterworkedItems||!s.allMasterworked&&e.ignoreArmorAffinitiesOnNonMasterworkedItems?l++:a[s.elements[0]]--,o.allMasterworked&&e.ignoreArmorAffinitiesOnMasterworkedItems||!o.allMasterworked&&e.ignoreArmorAffinitiesOnNonMasterworkedItems?l++:a[o.elements[0]]--;let c=Math.max(0,a[1])+Math.max(0,a[2])+Math.max(0,a[3])+Math.max(0,a[6])-l;var u=0;if(e.armorAffinities[rr.ArmorSlotClass].fixed&&(u=e.armorAffinities[rr.ArmorSlotClass].value),1==c&&0!=e.armorAffinities[rr.ArmorSlotClass].value){var h=!1;for(let e of[3,6,2,1])a[e]<=0||n.has(e)&&(h=!0,u=e);h&&c--}return{valid:c<=0,requiredClassItemElement:u}}function gr(e,t,n,r,i,s,o){var a=e.selectedExotics[0]||0;let l=t.slice();if((a<=0||r.items[0].hash!=a)&&e.armorPerks[rr.ArmorSlotHelmet].fixed&&e.armorPerks[rr.ArmorSlotHelmet].value!=ur.None&&e.armorPerks[rr.ArmorSlotHelmet].value!=r.perks[0])return{valid:!1};if((a<=0||i.items[0].hash!=a)&&e.armorPerks[rr.ArmorSlotGauntlet].fixed&&e.armorPerks[rr.ArmorSlotGauntlet].value!=ur.None&&e.armorPerks[rr.ArmorSlotGauntlet].value!=i.perks[0])return{valid:!1};if((a<=0||s.items[0].hash!=a)&&e.armorPerks[rr.ArmorSlotChest].fixed&&e.armorPerks[rr.ArmorSlotChest].value!=ur.None&&e.armorPerks[rr.ArmorSlotChest].value!=s.perks[0])return{valid:!1};if((a<=0||o.items[0].hash!=a)&&e.armorPerks[rr.ArmorSlotLegs].fixed&&e.armorPerks[rr.ArmorSlotLegs].value!=ur.None&&e.armorPerks[rr.ArmorSlotLegs].value!=o.perks[0])return{valid:!1};if(e.armorPerks[rr.ArmorSlotClass].fixed&&e.armorPerks[rr.ArmorSlotClass].value!=ur.None&&!n.has(e.armorPerks[rr.ArmorSlotClass].value))return{valid:!1};l[r.perks[0]]--,l[i.perks[0]]--,l[s.perks[0]]--,l[o.perks[0]]--,a>0&&(r.items[0].hash==a?l[e.armorPerks[r.items[0].slot].value]--:i.items[0].hash==a?l[e.armorPerks[i.items[0].slot].value]--:s.items[0].hash==a?l[e.armorPerks[s.items[0].slot].value]--:o.items[0].hash==a&&l[e.armorPerks[o.items[0].slot].value]--);let c=0;for(let f=1;f<ur.COUNT;f++)c+=Math.max(0,l[f]);var u=ur.None;if(1==c){var h=!1;for(let e=1;e<ur.COUNT&&!h;e++)l[e]<=0||n.has(e)&&(h=!0,u=e);h&&c--}else u==ur.None&&e.armorPerks[rr.ArmorSlotClass].fixed&&(u=e.armorPerks[rr.ArmorSlotClass].value);return{valid:c<=0,requiredClassItemType:u}}addEventListener("message",function(){var e=t(function*({data:e}){var n,r,i;const s=Date.now();console.debug("START RESULTS BUILDER 2"),console.time("total");const o=e.config;console.log("Using config",e.config);let a=yield Promise.all(o.selectedExotics.filter(e=>-1!=e).map(function(){var e=t(function*(e){return yield mr.where("hash").equals(e).first()});return function(t){return e.apply(this,arguments)}}()));a=a.filter(e=>!!e);let l=yield dr.where("clazz").equals(o.characterClass).distinct().toArray();l=l.filter(e=>e.slot!=rr.ArmorSlotNone).filter(e=>-1==o.disabledItems.indexOf(e.itemInstanceId)).filter(e=>-1==o.selectedExotics.indexOf(-1)||!e.isExotic).filter(e=>1!=a.length||a[0].slot!=e.slot||a[0].hash==e.hash).filter(e=>!o.onlyUseMasterworkedItems||e.masterworked).filter(e=>o.allowBlueArmorPieces||6==e.rarity||5==e.rarity).filter(e=>!o.ignoreSunsetArmor||!e.isSunset).filter(e=>!o.armorAffinities[e.slot].fixed||0==o.armorAffinities[e.slot].value||e.masterworked&&o.ignoreArmorAffinitiesOnMasterworkedItems||!e.masterworked&&o.ignoreArmorAffinitiesOnNonMasterworkedItems||o.armorAffinities[e.slot].value==e.energyAffinity).filter(e=>e.isExotic||!o.armorPerks[e.slot].fixed||o.armorPerks[e.slot].value==ur.None||o.armorPerks[e.slot].value==e.perk);let c=l.filter(e=>e.slot==rr.ArmorSlotHelmet).map(e=>new pr([e])),u=l.filter(e=>e.slot==rr.ArmorSlotGauntlet).map(e=>new pr([e])),h=l.filter(e=>e.slot==rr.ArmorSlotChest).map(e=>new pr([e])),f=l.filter(e=>e.slot==rr.ArmorSlotLegs).map(e=>new pr([e]));const d=e.threadSplit;if(d.count>1){var m=[[c,c.length],[u,u.length],[h,h.length],[f,f.length]].sort((e,t)=>e[1]-t[1])[0][0],p=Math.floor(m.length/d.count),y=p*d.current,g=p*(d.current+1);p*d.count!=m.length&&d.current==d.count-1&&(g+=m.length-p*d.count),m.splice(g),m.splice(0,y)}let v=l.filter(e=>e.slot==rr.ArmorSlotClass),b=new Set(v.map(e=>e.perk)),w=Array.from(b).reduce((e,t)=>{var n,r;e.has(t)||e.set(t,new Set),e.has(ur.None)||e.set(ur.None,new Set);for(let i of v.filter(e=>e.perk==t))null===(n=e.get(ur.None))||void 0===n||n.add(i.energyAffinity),null===(r=e.get(t))||void 0===r||r.add(i.energyAffinity);return e},new Map);if(a.length>1){let e=[...new Set(a.map(e=>e.slot))],t=l.filter(e=>e.hash==a[0].hash),n=l.filter(e=>e.hash==a[1].hash);if(1==e.length){let r=[];for(let e of t)for(let t of n)r.push(new pr([e,t]));switch(e[0]){case rr.ArmorSlotHelmet:c=r,u=u.filter(e=>!e.containsExotics),h=h.filter(e=>!e.containsExotics),f=f.filter(e=>!e.containsExotics);break;case rr.ArmorSlotGauntlet:u=r,c=c.filter(e=>!e.containsExotics),h=h.filter(e=>!e.containsExotics),f=f.filter(e=>!e.containsExotics);break;case rr.ArmorSlotChest:h=r,c=c.filter(e=>!e.containsExotics),u=u.filter(e=>!e.containsExotics),f=f.filter(e=>!e.containsExotics);break;case rr.ArmorSlotLegs:f=r,c=c.filter(e=>!e.containsExotics),u=u.filter(e=>!e.containsExotics),h=h.filter(e=>!e.containsExotics)}}else if(2==e.length){let r=l.filter(e=>e.slot==a[0].slot&&!e.isExotic),i=l.filter(e=>e.slot==a[1].slot&&!e.isExotic),s=[],o=[];for(let e of t)for(let t of i)s.push(new pr([e,t]));for(let e of n)for(let t of r)o.push(new pr([e,t]));c=c.filter(e=>!e.containsExotics),u=u.filter(e=>!e.containsExotics),h=h.filter(e=>!e.containsExotics),f=f.filter(e=>!e.containsExotics),e[0]===rr.ArmorSlotHelmet?c=s:e[0]===rr.ArmorSlotGauntlet?u=s:e[0]===rr.ArmorSlotChest?h=s:e[0]===rr.ArmorSlotLegs&&(f=s),e[1]===rr.ArmorSlotHelmet?c=o:e[1]===rr.ArmorSlotGauntlet?u=o:e[1]===rr.ArmorSlotChest?h=o:e[1]===rr.ArmorSlotLegs&&(f=o)}}console.debug("items",{helmets:c,gauntlets:u,chests:h,legs:f,availableClassItemTypes:b,availableClassItemEnergyPerkDict:w});const _={maximumPossibleTiers:[0,0,0,0,0,0],statCombo3x100:new Set,statCombo4x100:new Set},E=function(e){const t=[0,0,0,0,0,0];for(const n of e.enabledMods)for(const r of hr[n].bonus)t[r.stat==cr.ClassAbilityRegenerationStat?[1,0,2][e.characterClass]:r.stat]+=r.value;return t}(o),S=function(e){let t=[0,0,0,0,0,0,0];return t[e.armorAffinities[rr.ArmorSlotHelmet].value]++,t[e.armorAffinities[rr.ArmorSlotChest].value]++,t[e.armorAffinities[rr.ArmorSlotGauntlet].value]++,t[e.armorAffinities[rr.ArmorSlotLegs].value]++,e.armorAffinities[rr.ArmorSlotClass].fixed||t[e.armorAffinities[rr.ArmorSlotClass].value]++,t}(o),k=function(e){let t=[];for(let n=0;n<ur.COUNT;n++)t.push(0);return t[e.armorPerks[rr.ArmorSlotHelmet].value]++,t[e.armorPerks[rr.ArmorSlotChest].value]++,t[e.armorPerks[rr.ArmorSlotGauntlet].value]++,t[e.armorPerks[rr.ArmorSlotLegs].value]++,t[e.armorPerks[rr.ArmorSlotClass].value]++,t}(o),A=function(e){var t=[];return t.push(e.maximumModSlots[rr.ArmorSlotHelmet].value),t.push(e.maximumModSlots[rr.ArmorSlotGauntlet].value),t.push(e.maximumModSlots[rr.ArmorSlotChest].value),t.push(e.maximumModSlots[rr.ArmorSlotLegs].value),t.push(e.maximumModSlots[rr.ArmorSlotClass].value),t.where(e=>e>0).sort()}(o),O=S[0]<5,x=a.length<=1;let C=[],P=0,I=0,M=0,R=!1;console.time("tm");for(let t of c)for(let e of u)if(!(x&&t.containsExotics&&e.containsExotics))for(let s of h)if(!x||!t.containsExotics&&!e.containsExotics||!s.containsExotics)for(let a of f){if(x&&(t.containsExotics||e.containsExotics||s.containsExotics)&&a.containsExotics)continue;const l=gr(o,k,b,t,e,s,a);if(!l.valid)continue;var T=0;if(O){const i=yr(o,S,null!==(r=w.get(null!==(n=l.requiredClassItemType)&&void 0!==n?n:ur.None))&&void 0!==r?r:new Set,t,e,s,a);if(!i.valid)continue;T=i.requiredClassItemElement}const c=br(_,o,t,e,s,a,E,A.slice(),R);null!=c&&(M++,"DONOTSEND"!==c&&(c.classItem={perk:null!==(i=l.requiredClassItemType)&&void 0!==i?i:ur.None,affinity:T},C.push(c),P++,I++,R=R||o.limitParsedResults&&I>=5e4/d.count||I>=1e6/d.count)),P>=5e3&&(postMessage({runtime:_,results:C,done:!1,total:0}),C=[],P=0)}console.timeEnd("tm"),console.timeEnd("total"),postMessage({runtime:_,results:C,done:!0,stats:{permutationCount:M,itemCount:l.length-v.length,totalTime:Date.now()-s}})});return function(t){return e.apply(this,arguments)}}());class vr{constructor(e){this.list=[],this.comparatorList=[],this.length=0,this.comparator=e}insert(e){let t,n=this.comparator(e);for(t=0;t<this.list.length&&this.comparatorList[t]>n;t++);this.length++,this.list.splice(t,0,e),this.comparatorList.splice(t,0,n)}remove(e){let t=-1;for(let n=0;n<this.list.length;n++)if(this.list[n]==e){t=n;break}-1!=t&&(this.list.splice(t,1),this.comparatorList.splice(t,1),this.length--)}}function br(e,t,n,r,i,s,o,a,l=!1){const c=[n,r,i,s];var u=t.assumeClassItemMasterworked?2:0;for(let k=0;k<c.length;k++){let e=c[k];(e.allMasterworked||e.containsExotics&&!e.containsLegendaries&&t.assumeExoticsMasterworked||!e.containsExotics&&e.containsLegendaries&&t.assumeLegendariesMasterworked||e.containsExotics&&e.containsLegendaries&&t.assumeLegendariesMasterworked&&t.assumeExoticsMasterworked)&&(u+=2)}const h=function(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n].items.length>1?1:0;if(t<=1)return[e[0].mobility.min+e[1].mobility.min+e[2].mobility.min+e[3].mobility.min,e[0].resilience.min+e[1].resilience.min+e[2].resilience.min+e[3].resilience.min,e[0].recovery.min+e[1].recovery.min+e[2].recovery.min+e[3].recovery.min,e[0].discipline.min+e[1].discipline.min+e[2].discipline.min+e[3].discipline.min,e[0].intellect.min+e[1].intellect.min+e[2].intellect.min+e[3].intellect.min,e[0].strength.min+e[1].strength.min+e[2].strength.min+e[3].strength.min];{let t=e.filter(e=>1==e.items.length),n=e.filter(e=>e.items.length>1).reduce((e,t)=>(e[0]=t.mobility.sum<e[0]?t.mobility.sum:e[0],e[1]=t.resilience.sum<e[1]?t.resilience.sum:e[1],e[2]=t.recovery.sum<e[2]?t.recovery.sum:e[2],e[3]=t.discipline.sum<e[3]?t.discipline.sum:e[3],e[4]=t.intellect.sum<e[4]?t.intellect.sum:e[4],e[5]=t.strength.sum<e[5]?t.strength.sum:e[5],e),[200,200,200,200,200,200]);for(let e of t)n[0]+=e.mobility.min,n[1]+=e.resilience.min,n[2]+=e.recovery.min,n[3]+=e.discipline.min,n[4]+=e.intellect.min,n[5]+=e.strength.min;return n}}(c);h[0]+=u,h[1]+=u+(!c[2].containsExotics&&t.addConstent1Resilience?1:0),h[2]+=u,h[3]+=u,h[4]+=u,h[5]+=u;const f=[h[0],h[1],h[2],h[3],h[4],h[5]];h[0]+=o[0],h[1]+=o[1],h[2]+=o[2],h[3]+=o[3],h[4]+=o[4],h[5]+=o[5];for(let k=0;k<6;k++)if(t.minimumStatTiers[k].fixed&&h[k]/10>=t.minimumStatTiers[k].value+1)return null;const d=[Math.ceil(Math.max(0,t.minimumStatTiers[0].value-h[0]/10)),Math.ceil(Math.max(0,t.minimumStatTiers[1].value-h[1]/10)),Math.ceil(Math.max(0,t.minimumStatTiers[2].value-h[2]/10)),Math.ceil(Math.max(0,t.minimumStatTiers[3].value-h[3]/10)),Math.ceil(Math.max(0,t.minimumStatTiers[4].value-h[4]/10)),Math.ceil(Math.max(0,t.minimumStatTiers[5].value-h[5]/10))],m=d[0]+d[1]+d[2]+d[3]+d[4]+d[5],p=new vr(e=>lr[e][2]);if(m>5)return null;let y=a.length;if(m>y)return null;if(m>0){for(let e=0;e<6;e++){if(0==d[e])continue;const t=h[e]%10;t>0&&t%10>=5&&(p.insert(1+2*e),d[e]--,h[e]+=5);for(let n=0;n<d[e];n++)p.insert(2+2*e),h[e]+=10}for(let e=0;e<p.length&&p.length<=5;e++){const t=p.list[e],n=lr[t][2],r=a.where(e=>e>=n);if(0==r.length){if(t%2!=0)return null;{p.remove(t);let n=t-1;p.insert(n),p.insert(n),e--}}else a.splice(a.indexOf(r[0]),1),y--}}if(p.length>5)return null;if(t.onlyShowResultsWithNoWastedStats){if(h.where(e=>e>100).length>0)return null;if(h.where(e=>e%5!=0).length>0)return null;let e=[h[ar.Mobility],h[ar.Resilience],h[ar.Recovery],h[ar.Discipline],h[ar.Intellect],h[ar.Strength]].map((e,t)=>[e%10,t,e]).sort((e,t)=>t[0]-e[0]);for(let t=y-1;t>=0;t--){let t=e.where(e=>a.filter(t=>t>=lr[1+2*e[1]][2]).length>0).where(e=>e[0]>=5&&e[2]<100).sort((e,t)=>e[0]-t[0])[0];if(!t)break;const n=a.where(e=>e>=lr[1+2*t[1]][2])[0];a.splice(a.indexOf(n),1),y--,h[t[1]]+=5,t[0]-=5,p.insert(1+2*t[1])}if(_r(h)>0)return null}if(p.length>5)return null;const g=10*y,v=100-10*y,b=[];for(let k=0;k<6;k++){let t=h[k];if(t>=v&&b.push([k,100-t]),t+g>=e.maximumPossibleTiers[k]){let n=lr[1+2*k][2],r=lr[2+2*k][2];for(let e=0;e<y&&t<100;e++)a[e]>=r&&(t+=10),a[e]>=n&&a[e]<r&&(t+=5);t>e.maximumPossibleTiers[k]&&(e.maximumPossibleTiers[k]=t)}}if(y>0&&b.length>=3){b.sort((e,t)=>e[1]-t[1]);const t=[];for(let e=0;e<b.length-2;e++){let n=~~((Math.max(0,b[e][1],0)+9)/10);if(n>y)break;for(let r=e+1;r<b.length-1;r++){let i=~~((Math.max(0,b[r][1],0)+9)/10);if(n+i>y)break;for(let s=r+1;s<b.length;s++){let o=~~((Math.max(0,b[s][1],0)+9)/10);if(n+i+o>y)break;var w=!1;for(let a=s+1;a<b.length&&!(n+i+o+~~((Math.max(0,b[a][1],0)+9)/10)>y);a++)t.push([b[e],b[r],b[s],b[a]]),w=!0;w||t.push([b[e],b[r],b[s]])}}}for(let n of t){var _=[0,0,0,0,0,0];let t=0;for(let e=0;e<n.length;e++){if(n[e][1]<=0)continue;const r=n[e],i=r[0];let s=lr[1+2*i][2],o=lr[2+2*i][2];const a=Math.max(0,r[1]);let l=~~(a/10),c=a%10;c>5?l++:c>0&&(_[s]++,t++);for(let e=0;e<l;e++)_[o]++,t++}const r=[0,0,0,1,2,2],i=[!1,!1,!1,!1,!1];if(!(t>y)){for(let e=5;e>=3;e--){let n=_[e];if(0==n)continue;let s=a.map((e,t)=>[e,t]).filter(([t,n])=>!i[n]&&t>=e),o=n;for(let e=0;e<o&&e<s.length;e++)i[s[e][1]]=!0,n--;for(let i=0;i<n;i++)_[e]--,_[r[e]]+=2,t++;if(t>y)break}t<=y&&(e.statCombo3x100.add((1<<n[0][0])+(1<<n[1][0])+(1<<n[2][0])),n.length>3&&e.statCombo4x100.add((1<<n[0][0])+(1<<n[1][0])+(1<<n[2][0])+(1<<n[3][0])))}}}if(l)return"DONOTSEND";if(t.tryLimitWastedStats&&y>0){let e=[h[ar.Mobility],h[ar.Resilience],h[ar.Recovery],h[ar.Discipline],h[ar.Intellect],h[ar.Strength]].map((e,t)=>[e%10,t,e]).sort((e,t)=>t[0]-e[0]);for(let n=0;n<y;n++){let n=e.where(e=>a.where(t=>t>=lr[1+2*e[1]][2]).length>0).filter(e=>e[0]>=5&&e[2]<100).sort((e,t)=>e[0]-t[0])[0];if(!n)break;if(t.minimumStatTiers[n[1]].fixed&&(h[n[1]]+5)/10>=t.minimumStatTiers[n[1]].value+1){n[0]-=5;continue}const r=a.where(e=>e>=lr[1+2*n[1]][2])[0];a.splice(a.indexOf(r),1),y--,h[n[1]]+=5,n[0]-=5,p.insert(1+2*n[1])}}const E=_r(h);if(t.onlyShowResultsWithNoWastedStats&&E>0)return null;const S=n.containsExotics?n:r.containsExotics?r:i.containsExotics?i:s.containsExotics?s:null;return{exotic:null==S?[]:[{icon:null==S?void 0:S.items[0].icon,watermark:null==S?void 0:S.items[0].watermarkIcon,name:null==S?void 0:S.items[0].name,hash:null==S?void 0:S.items[0].hash}],modCount:p.length,modCost:p.list.reduce((e,t)=>e+lr[t][2],0),mods:p.list,stats:h,statsNoMods:f,tiers:wr(h),waste:E,items:c.map(e=>e.items).flat().reduce((e,t)=>(e[t.slot-1].push({energy:t.energyAffinity,energyLevel:t.energyLevel,hash:t.hash,itemInstanceId:t.itemInstanceId,name:t.name,exotic:!!t.isExotic,masterworked:t.masterworked,mayBeBugged:t.mayBeBugged,slot:t.slot,perk:t.perk,transferState:0,stats:[t.mobility,t.resilience,t.recovery,t.discipline,t.intellect,t.strength]}),e),[[],[],[],[]])}}function wr(e){return Math.floor(Math.min(100,e[ar.Mobility])/10)+Math.floor(Math.min(100,e[ar.Resilience])/10)+Math.floor(Math.min(100,e[ar.Recovery])/10)+Math.floor(Math.min(100,e[ar.Discipline])/10)+Math.floor(Math.min(100,e[ar.Intellect])/10)+Math.floor(Math.min(100,e[ar.Strength])/10)}function _r(e){return(e[ar.Mobility]>100?e[ar.Mobility]-100:e[ar.Mobility]%10)+(e[ar.Resilience]>100?e[ar.Resilience]-100:e[ar.Resilience]%10)+(e[ar.Recovery]>100?e[ar.Recovery]-100:e[ar.Recovery]%10)+(e[ar.Discipline]>100?e[ar.Discipline]-100:e[ar.Discipline]%10)+(e[ar.Intellect]>100?e[ar.Intellect]-100:e[ar.Intellect]%10)+(e[ar.Strength]>100?e[ar.Strength]-100:e[ar.Strength]%10)}})();