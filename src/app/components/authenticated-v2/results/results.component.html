<!--
  ~ Copyright (c) 2023 D2ArmorPicker by Mijago.
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as published
  ~ by the Free Software Foundation, either version 3 of the License, or
  ~ (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <http://www.gnu.org/licenses/>.
  -->

<mat-card appearance="outlined" id="card-results">
  <mat-card-header>
    <mat-card-title>Results</mat-card-title>
    <mat-card-subtitle>
      <ng-container *ngIf="this.totalResults > 0">
        Click on a row to expand it and to see the list of the items required for this build.<br />
      </ng-container>
      <ng-container *ngIf="this.totalResults === 0">
        <div class="no-found-sadcat-container">
          <img src="assets/status/emoji/sadcat.png" class="no-found-sadcat" />&nbsp;
        </div>
        <span class="warning-none-found"><b>No combinations found.</b></span>
        You should loosen your settings a bit.
      </ng-container>
    </mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div>
      <div
        class="config-summary-box"
        [style.display]="'flex'"
        [style.flex-direction]="'row'"
        [style.align-items]="'start center'"
        [style.gap]="'5px'">
        <mat-form-field
          appearance="outline"
          subscriptSizing="dynamic"
          class="info-box"
          [style.display]="'flex'">
          <mat-label>Items Used</mat-label>
          <input matInput readonly value="{{ this.itemCount | number }}" />
        </mat-form-field>
        <mat-form-field
          appearance="outline"
          subscriptSizing="dynamic"
          class="info-box"
          [style.display]="'flex'">
          <mat-label>Combinations generated</mat-label>
          <input matInput readonly value="{{ this.totalResults | number }}" />

          <mat-icon
            #tooltip="matTooltip"
            *ngIf="this.parsedResults !== this.totalResults && this.parsedResults === 5e4"
            class="report-problem-icon"
            matSuffix
            matTooltip="Note: To speed up the whole process, only {{
              this.parsedResults | number
            }} results are listed in this table.
                        If you need more entries, disable the limitation in the advanced settings."
            >report_problem
          </mat-icon>
          <mat-icon
            #tooltip="matTooltip"
            *ngIf="this.parsedResults !== this.totalResults && this.parsedResults === 1e6"
            class="report-problem-icon"
            matSuffix
            matTooltip="Note: To prevent Out-Of-Memory crashes, only {{
              this.parsedResults | number
            }} results are listed in this table.
                                You should narrow down your settings a bit."
            >report_problem
          </mat-icon>
        </mat-form-field>
        <mat-form-field
          appearance="outline"
          subscriptSizing="dynamic"
          class="info-box"
          [style.display]="'flex'">
          <mat-label>Time required</mat-label>
          <input matInput readonly value="{{ this.totalTime | number }}ms" />
        </mat-form-field>
      </div>

      <mat-form-field
        appearance="outline"
        subscriptSizing="dynamic"
        subscriptSizing="dynamic"
        class="config-summary-box"
        disabled>
        <mat-label>Summary of important configuration choices</mat-label>
        <input matInput readonly value="&nbsp;" class="hidden-input" />
        <mat-chip-listbox aria-label="Configuration Summary">
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_selectedExotics.indexOf(-1) > -1"
            disableRipple
            matTooltip="This setting enforces that all exotics are ignored."
            >No Exotic
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="
              _config_selectedExotics.length === 1 && _config_selectedExotics.indexOf(-1) === -1
            "
            disableRipple
            matTooltip="This setting enforces that only one specific exotic is used."
            >Exotic
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_selectedExotics.length > 1 && _config_selectedExotics.indexOf(-1) === -1"
            disableRipple
            matTooltip="The tool will try to fulfill your settings for all the selected exotics. If you select exotics in different slots then it will search for legendary items to allow hotswapping with the same stats.">
            Multiple Exotics
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_maximumStatMods === 0"
            disableRipple
            matTooltip="You enforced that no stat mods are used."
            >No stat mods
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_tryLimitWastedStats"
            disableRipple
            matTooltip="The tool will add minor stat mods to reduce wasted stats."
            >Reduce wasted stats
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_modslotLimitation.length > 0"
            disableRipple
            matTooltip="This setting limits available stat mod types, like major Super or Class."
            >Stat Mod Limitation
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_armorPerkLimitation.length > 0"
            disableRipple
            matTooltip="This setting enforces an specific armor perk or modslot for a specific armor slot.">
            Armor Perk or Slot
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_onlyShowResultsWithNoWastedStats"
            disableRipple
            matTooltip="This setting means that only builds with no wasted stats are shown."
            selected
            >Zero Waste
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_assumeEveryLegendaryIsArtifice"
            disableRipple
            matTooltip="EVERY legendary is assumed to be artifice."
            selected
            color="warn">
            <mat-icon inline style="height: 100%">report_problem</mat-icon>
            &nbsp;Assume legendaries are artifice&nbsp;
            <mat-icon inline style="height: 100%">report_problem</mat-icon>
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_assumeEveryExoticIsArtifice"
            disableRipple
            matTooltip="EVERY exotic is assumed to be artifice."
            selected
            color="warn">
            <mat-icon inline style="height: 100%">report_problem</mat-icon>
            &nbsp;Assume exotics are artifice&nbsp;
            <mat-icon inline style="height: 100%">report_problem</mat-icon>
          </mat-chip-option>

          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_onlyUseMasterworkedExotics"
            disableRipple
            matTooltip="This setting means that only exotic armor pieces that are already masterworked are used."
            selected>
            Masterworked Exotics Only
          </mat-chip-option>

          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_onlyUseMasterworkedLegendaries"
            disableRipple
            matTooltip="This setting means that only legendary armor pieces are already masterworked are used."
            selected>
            Masterworked Legendaries Only
          </mat-chip-option>

          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="
              !_config_onlyUseMasterworkedExotics &&
              !_config_onlyUseMasterworkedLegendaries &&
              (_config_assumeLegendariesMasterworked ||
                _config_assumeExoticsMasterworked ||
                _config_assumeClassItemMasterworked)
            "
            disableRipple
            matTooltip="Some masterwork assumptions are in place. This means that you may have to masterwork items. Look at your advanced settings to see which ones are activated.">
            Masterwork Assumption
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_includeCollectionRolls"
            disableRipple
            matTooltip="Collection Exotic rolls will be included in the search.">
            Include Collection Rolls
          </mat-chip-option>
          <mat-chip-option
            #tooltip="matTooltip"
            *ngIf="_config_includeVendorRolls"
            disableRipple
            matTooltip="Currently available Vendor items will be included in the search.">
            Include Vendor Items
          </mat-chip-option>
        </mat-chip-listbox>
      </mat-form-field>

      <div class="view-controls">
        <div class="hint-text">
          <mat-icon aria-hidden="false" inline>info</mat-icon>
          <span *ngIf="viewMode === 'table'"
            >Note that you can change the sort column and order of the table by clicking on the
            headers.</span
          >
          <span *ngIf="viewMode === 'cards'"
            >Use the filters and sort options above to customize your view.</span
          >
        </div>

        <mat-button-toggle-group
          [value]="viewMode"
          (change)="onViewModeChange($event)"
          aria-label="View Mode">
          <mat-button-toggle value="cards">
            <mat-icon>view_module</mat-icon>
            Cards
          </mat-button-toggle>
          <mat-button-toggle value="table">
            <mat-icon>table_view</mat-icon>
            Table
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Card View -->
      <app-results-card-view *ngIf="viewMode === 'cards'" [results]="_results" [config]="config">
      </app-results-card-view>

      <!-- Table View -->
      <table
        *ngIf="viewMode === 'table'"
        [dataSource]="tableDataSource"
        class="result-table"
        mat-table
        matSort
        matSortActive="Mods"
        matSortDirection="asc"
        multiTemplateDataRows>
        <!--- Note that these columns can be defined in any order.
         The actual rendered columns are set as a property on the row definition" -->
        <!-- Name Column -->
        <ng-container matColumnDef="weapon">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Weapon"
            matTooltip="The weapon Stat of this armor combination."
            >Weapon
          </th>
          <td *matCellDef="let element" class="statColumn" mat-cell
            >{{ element.stats[ArmorStat.StatWeapon] }}
            <img
              alt="Weapon"
              class="statIcon"
              src="https://www.bungie.net/common/destiny2_content/icons/e26e0e93a9daf4fdd21bf64eb9246340.png" />
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="health">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Health"
            matTooltip="The  stat of this armor combination.">
            Health
          </th>
          <td *matCellDef="let element" class="statColumn" mat-cell
            >{{ element.stats[ArmorStat.StatHealth] }}
            <img
              alt="Health"
              class="statIcon"
              src="https://www.bungie.net/common/destiny2_content/icons/202ecc1c6febeb6b97dafc856e863140.png" />
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="class">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Class"
            matTooltip="The class stat of this armor combination.">
            Class
          </th>
          <td *matCellDef="let element" class="statColumn" mat-cell
            >{{ element.stats[ArmorStat.StatClass] }}
            <img
              alt="Class"
              class="statIcon"
              src="https://www.bungie.net/common/destiny2_content/icons/128eee4ee7fc127851ab32eac6ca91cf.png" />
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="grenade">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Grenade"
            matTooltip="The grenade stat of this armor combination.">
            Grenade
          </th>
          <td *matCellDef="let element" class="statColumn" mat-cell
            >{{ element.stats[ArmorStat.StatGrenade] }}
            <img
              alt="Grenade"
              class="statIcon"
              src="https://www.bungie.net/common/destiny2_content/icons/79be2d4adef6a19203f7385e5c63b45b.png" />
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="super">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Super"
            matTooltip="The super stat of this armor combination.">
            Super
          </th>
          <td *matCellDef="let element" class="statColumn" mat-cell
            >{{ element.stats[ArmorStat.StatSuper] }}
            <img
              alt="Super"
              class="statIcon"
              src="https://www.bungie.net/common/destiny2_content/icons/d1c154469670e9a592c9d4cbdcae5764.png" />
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="melee">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Melee"
            matTooltip="The melee stat of this armor combination."
            >Melee
          </th>
          <td *matCellDef="let element" class="statColumn" mat-cell
            >{{ element.stats[ArmorStat.StatMelee] }}
            <img
              alt="Melee"
              class="statIcon"
              src="https://www.bungie.net/common/destiny2_content/icons/ea5af04ccd6a3470a44fd7bb0f66e2f7.png" />
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="mods">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Mods"
            matTooltip="The amount of mods required for each combination. Sorting after this takes the mod cost into account.">
            Used Mods
          </th>
          <td *matCellDef="let element" mat-cell>
            <app-table-mod-display
              [mods]="element.mods"
              [artifice]="element.artifice"
              class="modPreview"></app-table-mod-display>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="exotic">
          <th *matHeaderCellDef mat-header-cell style="text-align: center">Exotic</th>
          <td *matCellDef="let element" mat-cell>
            <div class="itemDiv">
              <img
                *ngIf="element.exotic !== undefined"
                #tooltip="matTooltip"
                class="itemIcon"
                matTooltip="{{ element.exotic.name }}"
                src="https://bungie.net/{{ element.exotic.icon }}" />
              <img
                *ngIf="element.exotic !== undefined"
                class="itemIconWatermark"
                src="https://bungie.net/{{ element.exotic.watermark }}" />
              <img
                *ngIf="element.exotic === undefined"
                class="itemIcon"
                src="https://www.bungie.net/common/destiny2_content/icons/b4d05ef69d0c3227a7d4f7f35bbc2848.png" />
            </div>
          </td>
        </ng-container>

        <!-- Vendor/Collection Column -->
        <ng-container matColumnDef="source">
          <th *matHeaderCellDef mat-header-cell>Sources</th>
          <td *matCellDef="let element" mat-cell>
            <span class="source-column">
              <img
                *ngIf="!!element.usesCollectionRoll"
                matTooltip="This build uses a collection exotic. You have to collect it before you can use it."
                class="collectionIcon"
                src="https://www.bungie.net/common/destiny2_content/icons/1d01287dd47af97fef16fa6acbac23ba.png" />
              <img
                *ngIf="!!element.usesVendorRoll"
                matTooltip="This build uses a vendor item. You have to collect it before you can use it."
                class="vendorIcon"
                src="https://www.bungie.net/common/destiny2_content/icons/8ef4b5bd32277dba9aee7c368404ad5d.jpg" />
            </span>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="dropdown">
          <th *matHeaderCellDef mat-header-cell></th>
          <td *matCellDef="let element" mat-cell>
            <mat-icon
              *ngIf="expandedElement !== element"
              matTooltip="Click to show details for this build.">
              expand_more
            </mat-icon>
            <mat-icon
              *ngIf="expandedElement === element"
              matTooltip="Click to hide details for this build.">
              expand_less
            </mat-icon>

            <mat-icon
              #tooltip="matTooltip"
              *ngIf="checkIfAnyItemsMayBeInvalid(element)"
              aria-hidden="false"
              aria-label="Error"
              class="report-problem-icon"
              inline
              matTooltip="The stats of this build may be incorrect. Make sure that you remove every positive or negative stat modifier from the marked items.">
              report_problem
            </mat-icon>
          </td>
        </ng-container>

        <!-- Total Column -->
        <ng-container matColumnDef="total">
          <th
            *matHeaderCellDef
            mat-header-cell
            mat-sort-header="Total"
            matTooltip="The total sum of all stats in this armor combination."
            >Total
          </th>
          <td *matCellDef="let element" mat-cell>
            {{ getTotalStats(element) }}
          </td>
        </ng-container>

        <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
        <ng-container matColumnDef="expandedDetail">
          <td *matCellDef="let element" [attr.colspan]="shownColumns.length" mat-cell>
            <div
              [@detailExpand]="element === expandedElement ? 'expanded' : 'collapsed'"
              class="result-element-detail">
              <app-expanded-result-content [element]="element"></app-expanded-result-content>
            </div>
          </td>
        </ng-container>

        <tr *matHeaderRowDef="shownColumns" mat-header-row></tr>
        <tr
          (click)="expandedElement = expandedElement === element ? null : element"
          *matRowDef="let element; columns: shownColumns"
          [class.example-expanded-row]="expandedElement === element"
          class="result-element-row"
          mat-row>
        </tr>
        <tr
          *matRowDef="let row; columns: ['expandedDetail']"
          class="result-detail-row"
          mat-row></tr>
      </table>
      <mat-paginator
        [pageSizeOptions]="[25, 50, 75, 100]"
        aria-label="Select page of periodic elements"
        pageSize="25"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  </mat-card-content>
  <mat-card-actions *ngIf="totalResults > 0">
    <span class="flex-spacer"></span>

    <button mat-raised-button color="primary" (click)="saveBuilds()"
      >Download results as JSON</button
    >
  </mat-card-actions>
</mat-card>
